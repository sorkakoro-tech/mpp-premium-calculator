<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–µ–º–∏–∏ –ú–ü–ü</title>
<base href="/mpp-premium-calculator/">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
:root {
  --primary: #2c3e50;
  --secondary: #3498db;
  --accent: #e74c3c;
  --success: #27ae60;
  --warning: #f39c12;
  --light: #ecf0f1;
  --dark: #34495e;
  --bg-color: #ffffff;
  --text-color: #333333;
  --card-bg: #f8f9fa;
  --border-color: #ddd;
}

[data-theme="dark"] {
  --primary: #3498db;
  --secondary: #2980b9;
  --accent: #e74c3c;
  --success: #27ae60;
  --warning: #f39c12;
  --light: #2c3e50;
  --dark: #ecf0f1;
  --bg-color: #1a1a1a;
  --text-color: #ffffff;
  --card-bg: #2d2d2d;
  --border-color: #444;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
  background: var(--bg-color);
  min-height: 100vh;
  color: var(--text-color);
  font-size: 16px;
  transition: all 0.3s ease;
}

.container {
  display: none;
  max-width: 100%;
  margin: 0 auto;
  background: var(--bg-color);
  border-radius: 15px;
  overflow: hidden;
  position: relative;
  transition: all 0.3s ease;
  padding-bottom: 70px;
}

header {
  background: var(--primary);
  color: white;
  padding: 15px 10px;
  text-align: center;
  position: relative;
  z-index: 100;
}

header h1 {
  font-size: 20px;
  margin-bottom: 5px;
}

header p {
  opacity: 0.9;
  font-size: 12px;
}

.user-info {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  color: white;
  font-size: 14px;
  margin-top: 10px;
}

.user-avatar {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  background: var(--secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 16px;
}

.calculator-container {
  padding: 15px 10px;
}

.section {
  margin-bottom: 20px;
  padding: 12px;
  border-radius: 10px;
  background: var(--card-bg);
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
  border: 1px solid var(--border-color);
  transition: all 0.3s ease;
}

.section-title {
  color: var(--primary);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--secondary);
  font-size: 18px;
  display: flex;
  align-items: center;
}

.section-title i {
  margin-right: 8px;
  font-size: 20px;
}

.form-group {
  margin-bottom: 12px;
}

label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: var(--text-color);
  font-size: 14px;
}

input, select, textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.3s;
  background: var(--bg-color);
  color: var(--text-color);
}

input:focus, select:focus, textarea:focus {
  border-color: var(--secondary);
  box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
  outline: none;
}

.plan-fact-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 12px;
}

.credit-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 12px;
  align-items: end;
  padding: 12px;
  background: var(--card-bg);
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  border: 1px solid var(--border-color);
}

.btn {
  background: var(--secondary);
  color: white;
  border: none;
  padding: 14px 16px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-height: 50px;
  width: 100%;
  margin-bottom: 8px;
}

.btn:hover {
  background: #2980b9;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.btn i {
  margin-right: 8px;
}

.btn-remove {
  background: var(--accent);
  padding: 10px;
  font-size: 14px;
}

.btn-remove:hover {
  background: #c0392b;
}

.result-card {
  background: var(--card-bg);
  padding: 12px;
  margin-bottom: 12px;
  border-radius: 8px;
  border-left: 4px solid var(--success);
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
  border: 1px solid var(--border-color);
}

.result-title {
  font-weight: bold;
  margin-bottom: 8px;
  color: var(--primary);
  font-size: 16px;
}

.result-value {
  font-size: 16px;
  font-weight: bold;
  color: var(--success);
}

.final-result {
  background: linear-gradient(135deg, var(--success), #2ecc71);
  color: white;
  padding: 20px 12px;
  text-align: center;
  border-radius: 10px;
  margin-top: 15px;
}

.final-amount {
  font-size: 28px;
  font-weight: bold;
  margin: 8px 0;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
}

.calculation-steps {
  background: var(--card-bg);
  padding: 12px;
  border-radius: 8px;
  margin-top: 15px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
  border: 1px solid var(--border-color);
}

.step {
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-color);
}

.step:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.step-title {
  font-weight: bold;
  margin-bottom: 5px;
  color: var(--text-color);
}

.nav-tabs {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card-bg);
  display: none;
  justify-content: space-around;
  padding: 10px 5px;
  border-top: 1px solid var(--border-color);
  z-index: 1000;
}

.nav-tab {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 8px 12px;
  border-radius: 8px;
  color: var(--text-color);
  text-decoration: none;
  font-size: 12px;
  transition: all 0.3s;
  flex: 1;
  margin: 0 5px;
}

.nav-tab.active {
  background: var(--secondary);
  color: white;
}

.nav-tab i {
  font-size: 18px;
  margin-bottom: 4px;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.theme-toggle {
  position: fixed;
  bottom: 70px;
  right: 20px;
  background: var(--secondary);
  color: white;
  border: none;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 20px;
  z-index: 1000;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.theme-toggle:hover {
  background: #2980b9;
  transform: scale(1.1);
}

.loader {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  color: white;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  flex-direction: column;
}

.loader-spinner {
  width: 50px;
  height: 50px;
  border: 5px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s ease-in-out infinite;
  margin-bottom: 15px;
}

.loader-text {
  font-size: 16px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-message {
  background: var(--accent);
  color: white;
  padding: 12px;
  border-radius: 8px;
  margin: 10px 0;
  display: none;
}

.success-message {
  background: var(--success);
  color: white;
  padding: 12px;
  border-radius: 8px;
  margin: 10px 0;
  display: none;
}

@media (max-width: 360px) {
  body {
    font-size: 14px;
    padding: 5px;
  }
  .calculator-container {
    padding: 10px 5px;
  }
  .section {
    padding: 10px;
    margin-bottom: 15px;
  }
  .section-title {
    font-size: 16px;
  }
  input, select {
    padding: 10px;
    font-size: 16px;
  }
  .btn {
    padding: 12px;
    font-size: 16px;
  }
  .final-amount {
    font-size: 24px;
  }
}

.week-selector {
  display: flex;
  gap: 5px;
  margin-bottom: 15px;
}

.week-btn {
  flex: 1;
  padding: 8px;
  border: 1px solid var(--border-color);
  background: var(--card-bg);
  color: var(--text-color);
  border-radius: 5px;
  cursor: pointer;
}

.week-btn.active {
  background: var(--secondary);
  color: white;
}

.leaderboard-item {
  display: flex;
  justify-content: space-between;
  padding: 10px;
  background: var(--card-bg);
  margin-bottom: 5px;
  border-radius: 5px;
  border: 1px solid var(--border-color);
}

.rank {
  font-weight: bold;
  width: 30px;
}

.name {
  flex: 1;
}

.value {
  font-weight: bold;
  color: var(--success);
}

.badge-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.badge {
  background: var(--card-bg);
  padding: 15px 10px;
  border-radius: 10px;
  text-align: center;
  border: 1px solid var(--border-color);
}

.badge-icon {
  font-size: 24px;
  margin-bottom: 5px;
  color: var(--secondary);
}

.badge-name {
  font-weight: bold;
  font-size: 12px;
  margin-bottom: 3px;
}

.badge-desc {
  font-size: 10px;
  opacity: 0.7;
}

.badge.locked {
  opacity: 0.5;
}

.badge.unlocked {
  border-color: var(--success);
}

.monthly-report-section {
  margin-top: 20px;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: var(--bg-color);
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  border-bottom: 1px solid var(--border-color);
  padding-bottom: 10px;
}

.modal-title {
  font-size: 18px;
  font-weight: bold;
  color: var(--primary);
}

.close-modal {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--text-color);
}

.week-options {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  margin-bottom: 15px;
}

.week-option {
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
}

.week-option:hover {
  border-color: var(--secondary);
  background: rgba(52, 152, 219, 0.1);
}

.week-option.selected {
  border-color: var(--secondary);
  background: rgba(52, 152, 219, 0.2);
}

.week-range {
  font-weight: bold;
  margin-bottom: 5px;
}

.week-days {
  font-size: 12px;
  opacity: 0.7;
}

.alert {
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 15px;
  background: var(--warning);
  color: white;
}

.alert i {
  margin-right: 8px;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-color);
}

.detail-label {
  color: var(--text-color);
}

.detail-value {
  font-weight: bold;
  color: var(--success);
}

.strata-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  background: var(--secondary);
  color: white;
  font-size: 12px;
  margin-left: 5px;
}

.multiplier-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  background: var(--success);
  color: white;
  font-size: 12px;
  margin-left: 5px;
}

.points-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  background: var(--warning);
  color: white;
  font-size: 12px;
  margin-left: 5px;
}

.final-strata-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 16px;
  background: var(--primary);
  color: white;
  font-size: 14px;
  font-weight: bold;
  margin-left: 10px;
}

.premium-structure {
  margin-top: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.chart-container {
  position: relative;
  width: 100%;
  height: 250px;
  margin: 15px auto;
}

.premium-chart {
  width: 100%;
  height: 100%;
}

.chart-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  background: var(--bg-color);
  border-radius: 50%;
  width: 80px;
  height: 80px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  border: 2px solid var(--border-color);
}

.chart-total {
  font-weight: bold;
  font-size: 14px;
  color: var(--primary);
}

.chart-percent {
  font-size: 12px;
  color: var(--text-color);
  opacity: 0.8;
}

.chart-legend {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  width: 100%;
  margin-top: 15px;
}

.legend-item {
  display: flex;
  align-items: center;
  font-size: 12px;
  padding: 5px;
  border-radius: 5px;
  background: var(--card-bg);
}

.legend-color {
  width: 15px;
  height: 15px;
  border-radius: 3px;
  margin-right: 8px;
}

.legend-label {
  flex: 1;
}

.legend-value {
  font-weight: bold;
  color: var(--success);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ */
.admin-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.stat-card {
  background: var(--card-bg);
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  border: 1px solid var(--border-color);
}

.stat-value {
  font-size: 24px;
  font-weight: bold;
  color: var(--secondary);
  margin-bottom: 5px;
}

.stat-label {
  font-size: 14px;
  opacity: 0.8;
}

.admin-table-container {
  overflow-x: auto;
  margin-top: 15px;
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
  background: var(--card-bg);
}

.admin-table th,
.admin-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.admin-table th {
  background: var(--primary);
  color: white;
  font-weight: 600;
}

.admin-table tr:hover {
  background: rgba(52, 152, 219, 0.1);
}

.admin-controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.btn-warning {
  background: var(--warning);
}

.btn-warning:hover {
  background: #e67e22;
}

.btn-danger {
  background: var(--accent);
}

.btn-danger:hover {
  background: #c0392b;
}

.user-role-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 10px;
  margin-left: 5px;
}

.role-admin {
  background: #e74c3c;
  color: white;
}

.role-mpp {
  background: #3498db;
  color: white;
}

.admin-user-controls {
  display: flex;
  gap: 5px;
}

.admin-user-btn {
  padding: 4px 8px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.btn-promote {
  background: #27ae60;
  color: white;
}

.btn-demote {
  background: #e74c3c;
  color: white;
}

/* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ –∏ –ø—Ä–æ—Ñ–∏–ª—è */
.report-type-selector {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.report-type-btn {
  flex: 1;
  padding: 10px;
  border: 1px solid var(--border-color);
  background: var(--card-bg);
  color: var(--text-color);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
}

.report-type-btn.active {
  background: var(--secondary);
  color: white;
  border-color: var(--secondary);
}

.report-form {
  display: none;
}

.report-form.active {
  display: block;
}

.month-selector {
  margin-bottom: 15px;
}

.month-select {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 16px;
  background: var(--bg-color);
  color: var(--text-color);
}

.profile-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  margin-bottom: 15px;
}

.profile-stat {
  background: var(--card-bg);
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  border: 1px solid var(--border-color);
}

.profile-stat-value {
  font-size: 18px;
  font-weight: bold;
  color: var(--secondary);
  margin-bottom: 5px;
}

.profile-stat-label {
  font-size: 12px;
  opacity: 0.8;
}

.premium-history {
  margin-top: 15px;
}

.history-item {
  display: flex;
  justify-content: space-between;
  padding: 10px;
  background: var(--card-bg);
  margin-bottom: 5px;
  border-radius: 5px;
  border: 1px solid var(--border-color);
}

.history-month {
  font-weight: bold;
}

.history-premium {
  font-weight: bold;
  color: var(--success);
}

.leaderboard-period-selector {
  display: flex;
  gap: 5px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.period-btn {
  flex: 1;
  padding: 8px;
  border: 1px solid var(--border-color);
  background: var(--card-bg);
  color: var(--text-color);
  border-radius: 5px;
  cursor: pointer;
  min-width: 100px;
}

.period-btn.active {
  background: var(--secondary);
  color: white;
}

.last-month-leaderboard {
  margin-top: 20px;
  padding-top: 15px;
  border-top: 2px solid var(--border-color);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ–º–∏–∏ */
.edit-premium-btn {
  background: none;
  border: none;
  color: var(--secondary);
  cursor: pointer;
  margin-left: 8px;
  font-size: 14px;
}

.edit-premium-btn:hover {
  color: var(--primary);
}

.no-report {
  color: var(--accent);
  font-style: italic;
}

@media (max-width: 768px) {
  .admin-table {
    font-size: 14px;
  }
  
  .admin-table th,
  .admin-table td {
    padding: 8px 6px;
  }
  
  .admin-controls {
    flex-direction: column;
  }
  
  .admin-user-controls {
    flex-direction: column;
  }
  
  .report-type-selector {
    flex-direction: column;
  }
  
  .leaderboard-period-selector {
    flex-direction: column;
  }
  
  .period-btn {
    min-width: auto;
  }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤–æ–π –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ */
.admin-plans-form {
  margin-top: 20px;
}

.plan-input-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 15px;
}

.plan-input {
  background: var(--bg-color);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 12px;
}

.plan-input label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--text-color);
}

.plan-input input {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border-color);
  border-radius: 5px;
  font-size: 16px;
  background: var(--bg-color);
  color: var(--text-color);
}

.admin-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 2px solid var(--border-color);
  padding-bottom: 10px;
}

.admin-tab {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  background: var(--card-bg);
  color: var(--text-color);
  cursor: pointer;
  transition: all 0.3s;
  font-size: 16px;
}

.admin-tab.active {
  background: var(--secondary);
  color: white;
}

.admin-content {
  display: none;
}

.admin-content.active {
  display: block;
}

.visits-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.visit-stat-card {
  background: var(--card-bg);
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  border: 1px solid var(--border-color);
}

.visit-stat-value {
  font-size: 24px;
  font-weight: bold;
  color: var(--secondary);
  margin-bottom: 5px;
}

.visit-stat-label {
  font-size: 14px;
  opacity: 0.8;
}

.reports-summary {
  margin-top: 20px;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.summary-card {
  background: var(--card-bg);
  padding: 15px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.summary-title {
  font-weight: bold;
  margin-bottom: 10px;
  color: var(--primary);
}

.summary-value {
  font-size: 18px;
  font-weight: bold;
  color: var(--success);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö */
.changes-notification {
  background: linear-gradient(135deg, #ffd700, #ffa500);
  color: #333;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 20px;
  border: 1px solid #ffa500;
  box-shadow: 0 3px 10px rgba(255, 165, 0, 0.2);
}

.changes-header {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.changes-header i {
  font-size: 20px;
  margin-right: 10px;
  color: #333;
}

.changes-title {
  font-weight: bold;
  font-size: 16px;
}

.changes-content {
  font-size: 14px;
  line-height: 1.4;
}

.changes-date {
  font-size: 12px;
  opacity: 0.7;
  margin-top: 8px;
  text-align: right;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
.changes-form textarea {
  min-height: 200px;
  resize: vertical;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∫–æ—Ä–¥–æ–≤ –ø—Ä–æ–¥–∞–∂ */
.records-container {
  margin-top: 20px;
}

.record-item {
  background: var(--card-bg);
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  border: 1px solid var(--border-color);
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.record-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-color);
}

.record-title {
  font-weight: bold;
  font-size: 16px;
  color: var(--primary);
}

.record-value {
  font-size: 18px;
  font-weight: bold;
  color: var(--success);
}

.record-user {
  font-size: 14px;
  color: var(--text-color);
  margin-top: 5px;
}

.record-form {
  background: var(--card-bg);
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  border: 1px solid var(--border-color);
}

.record-form-title {
  font-weight: bold;
  margin-bottom: 15px;
  color: var(--primary);
  font-size: 16px;
}

.record-input-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 15px;
}

.record-input {
  margin-bottom: 10px;
}

.record-input label {
  display: block;
  margin-bottom: 5px;
  font-weight: 600;
  color: var(--text-color);
  font-size: 14px;
}

.record-input input, .record-input select {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border-color);
  border-radius: 5px;
  font-size: 14px;
  background: var(--bg-color);
  color: var(--text-color);
}

.record-btn {
  background: var(--secondary);
  color: white;
  border: none;
  padding: 12px 20px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  margin-top: 10px;
}

.record-btn:hover {
  background: #2980b9;
}

.record-btn i {
  margin-right: 8px;
}

/* –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ü–û–ò–°–ö–ê –°–û–¢–†–£–î–ù–ò–ö–û–í */
.custom-select-wrapper {
  position: relative;
  width: 100%;
}

.search-input-container {
  position: relative;
  width: 100%;
}

.search-input {
  width: 100%;
  padding: 12px 40px 12px 12px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 16px;
  background: var(--bg-color);
  color: var(--text-color);
}

.search-icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-color);
  opacity: 0.7;
}

.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--bg-color);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.search-result-item {
  padding: 10px 12px;
  cursor: pointer;
  border-bottom: 1px solid var(--border-color);
  transition: all 0.2s;
}

.search-result-item:hover {
  background: var(--secondary);
  color: white;
}

.search-result-item:last-child {
  border-bottom: none;
}

.no-results {
  padding: 10px 12px;
  color: var(--text-color);
  opacity: 0.7;
  font-style: italic;
}

.selected-user {
  margin-top: 10px;
  padding: 10px;
  background: var(--card-bg);
  border-radius: 8px;
  border: 1px solid var(--border-color);
  font-weight: bold;
  color: var(--success);
}

@media (max-width: 768px) {
  .record-input-group {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>
<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div class="loader" id="globalLoader">
  <div class="loader-spinner"></div>
  <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ —É—Å–ø–µ—Ö–µ -->
<div class="error-message" id="errorMessage"></div>
<div class="success-message" id="successMessage"></div>

<div class="container">
<header>
<h1><i class="fas fa-calculator" id="headerIcon"></i> <span id="headerTitle">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–µ–º–∏–∏ –ú–ü–ü</span></h1>
<p id="headerSubtitle">–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –≤–∞—à—É –ø—Ä–µ–º–∏—é –ø–æ –Ω–æ–≤—ã–º –ø—Ä–∞–≤–∏–ª–∞–º</p>
<div class="user-info" id="userInfo">
<div class="user-avatar" id="userAvatar">U</div>
<span id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
<span id="userRole" style="margin-left: 10px; font-size: 12px; opacity: 0.8;">–ú–ü–ü</span>
</div>
</header>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —É –≤—Å–µ—Ö –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ) -->
<div id="motivation-changes-notification" class="changes-notification" style="display: none;">
  <div class="changes-header">
    <i class="fas fa-exclamation-circle"></i>
    <div class="changes-title">–í–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ—Ç–∏–≤–∞—Ü–∏–∏</div>
  </div>
  <div class="changes-content" id="motivation-changes-content"></div>
  <div class="changes-date" id="motivation-changes-date"></div>
</div>

<!-- –†–∞–∑–¥–µ–ª –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –¥–ª—è –ú–ü–ü -->
<div class="tab-content active" id="calculator-tab">
<div class="calculator-container" id="mpp-calculator">
<!-- –°–µ–∫—Ü–∏—è 1: –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å -->
<div class="section">
<h2 class="section-title"><i class="fas fa-user-tie"></i> –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
<div class="form-group">
<label for="moscow_coef">–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç:</label>
<select id="moscow_coef">
<option value="1">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (√ó1.0)</option>
<option value="1.3" selected>–ú–æ—Å–∫–≤–∞ (√ó1.3)</option>
</select>
</div>
<div class="form-group">
<label for="position">–î–æ–ª–∂–Ω–æ—Å—Ç—å:</label>
<select id="position">
<option value="0" selected>–ú–ü–ü</option>
<option value="3000">–°—Ç–∞—Ä—à–∏–π –ú–ü–ü (+3,000‚ÇΩ)</option>
<option value="5000">–í–µ–¥—É—â–∏–π –ú–ü–ü (+5,000‚ÇΩ)</option>
<option value="10000">–ì–ª–∞–≤–Ω—ã–π –ú–ü–ü (+10,000‚ÇΩ)</option>
<option value="20000">–≠–∫—Å–ø–µ—Ä—Ç –ú–ü–ü (+20,000‚ÇΩ)</option>
</select>
</div>
</div>

<!-- –°–µ–∫—Ü–∏—è 2: –ü–ª–∞–Ω/–§–∞–∫—Ç –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º -->
<div class="section">
<h2 class="section-title"><i class="fas fa-chart-line"></i> –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
<div class="plan-fact-container">
<div>
<label for="krh_plan">–ö–†–• (–ø–ª–∞–Ω, —à—Ç.):</label>
<input type="number" id="krh_plan" min="0" max="1000" value="14">
</div>
<div>
<label for="krh_fact">–ö–†–• (—Ñ–∞–∫—Ç, —à—Ç.):</label>
<input type="number" id="krh_fact" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label for="vklad_volume_plan">–í–∫–ª–∞–¥ –æ–±—ä–µ–º (–ø–ª–∞–Ω, —Ä—É–±.):</label>
<input type="number" id="vklad_volume_plan" min="0" max="100000000" value="1920000">
</div>
<div>
<label for="vklad_volume_fact">–í–∫–ª–∞–¥ –æ–±—ä–µ–º (—Ñ–∞–∫—Ç, —Ä—É–±.):</label>
<input type="number" id="vklad_volume_fact" min="0" max="100000000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label for="vklad_count_plan">–í–∫–ª–∞–¥—ã (–ø–ª–∞–Ω, —à—Ç.):</label>
<input type="number" id="vklad_count_plan" min="0" max="1000" value="4">
</div>
<div>
<label for="vklad_count_fact">–í–∫–ª–∞–¥—ã (—Ñ–∞–∫—Ç, —à—Ç.):</label>
<input type="number" id="vklad_count_fact" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label for="dk_count_plan">–î–ö (–ø–ª–∞–Ω, —à—Ç.):</label>
<input type="number" id="dk_count_plan" min="0" max="1000" value="2">
</div>
<div>
<label for="dk_volume_plan">–î–ö –æ–±—ä–µ–º (–ø–ª–∞–Ω, —Ä—É–±.):</label>
<input type="number" id="dk_volume_plan" min="0" max="100000000" value="960000">
</div>
</div>
<div class="plan-fact-container">
<div>
<label for="dk_volume_fact">–î–ö –æ–±—ä–µ–º (—Ñ–∞–∫—Ç, —Ä—É–±.):</label>
<input type="number" id="dk_volume_fact" min="0" max="100000000" value="0" readonly style="background-color: #f0f8ff;">
</div>
<div>
<label for="kvc_plan">–ö–í–¶ (–ø–ª–∞–Ω, –∫–ª–∏–µ–Ω—Ç—ã):</label>
<input type="number" id="kvc_plan" min="0" max="1000" value="30">
</div>
</div>
<div class="plan-fact-container">
<div>
<label for="kvc_fact">–ö–í–¶ (—Ñ–∞–∫—Ç, –∫–ª–∏–µ–Ω—Ç—ã):</label>
<input type="number" id="kvc_fact" min="0" max="1000" value="0">
</div>
</div>
</div>

<!-- –°–µ–∫—Ü–∏—è 3: –ö—Ä–µ–¥–∏—Ç—ã -->
<div class="section">
<h2 class="section-title"><i class="fas fa-credit-card"></i> –ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã</h2>
<p style="margin-bottom: 15px; color: #666;">–î–æ–±–∞–≤—å—Ç–µ –≤—Å–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–∏–ø–∞, –ø–∞–∫–µ—Ç–∞ –∑–∞—â–∏—Ç—ã –∏ –§–ó</p>
<div id="credits-container">
<!-- –ö—Ä–µ–¥–∏—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</div>
<button class="btn" id="add-credit-btn">
<i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–µ–¥–∏—Ç
</button>
</div>

<!-- –°–µ–∫—Ü–∏—è 4: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã -->
<div class="section">
<h2 class="section-title"><i class="fas fa-cube"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã</h2>
<div class="plan-fact-container">
<div>
<label for="omp_count">–û–ú–ü (—à—Ç.):</label>
<input type="number" id="omp_count" min="0" max="1000" value="0">
</div>
<div>
<label for="zp_nerez_count">–ó–ü –Ω–µ—Ä–µ–∑ (—à—Ç.):</label>
<input type="number" id="zp_nerez_count" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label for="sticker_count">–°—Ç–∏–∫–µ—Ä—ã:</label>
<input type="number" id="sticker_count" min="0" max="1000" value="0">
</div>
<div>
<label for="year_sub_count">–ü–æ–¥–ø–∏—Å–∫–∏ –≥–æ–¥–æ–≤—ã–µ:</label>
<input type="number" id="year_sub_count" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label for="month_sub_count">–ü–æ–¥–ø–∏—Å–∫–∏ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ:</label>
<input type="number" id="month_sub_count" min="0" max="1000" value="0">
</div>
<div>
<label for="krh_limit_count">–ö–†–• –õ–∏–º–∏—Ç:</label>
<input type="number" id="krh_limit_count" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label for="zp_card_count">–ó–ü –∫–∞—Ä—Ç—ã:</label>
<input type="number" id="zp_card_count" min="0" max="1000" value="0">
</div>
<div>
<label for="card_turnover">–û–±–æ—Ä–æ—Ç –ø–æ –∫–∞—Ä—Ç–∞–º (—Ä—É–±.):</label>
<input type="number" id="card_turnover" min="0" max="100000000" value="0">
</div>
</div>
</div>

<!-- –°–µ–∫—Ü–∏—è 5: –ß–µ–º–ø–∏–æ–Ω–∞—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤ -->
<div class="section">
<h2 class="section-title"><i class="fas fa-trophy"></i> –ß–µ–º–ø–∏–æ–Ω–∞—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤</h2>
<div class="plan-fact-container">
<div>
<label for="skb_count">–°–ö–ë (–¥–µ–±–µ—Ç–æ–≤—ã–µ —Å 2%):</label>
<input type="number" id="skb_count" min="0" max="1000" value="0">
</div>
<div>
<label for="crm_calls">–î–æ–∑–≤–æ–Ω—ã CRM:</label>
<input type="number" id="crm_calls" min="0" max="1000" value="0">
</div>
</div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ -->
<div style="text-align: center; margin: 25px 0;">
<button class="btn" id="calculate-btn">
<i class="fas fa-calculator"></i> –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–µ–º–∏—é
</button>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
<div id="results" style="display: none;">
<div class="result-card">
<div class="result-title">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –∏ —Å—Ç—Ä–∞—Ç—ã:</div>
<div id="plan_results"></div>
</div>
<div class="result-card">
<div class="result-title">–†–∞—Å—á–µ—Ç –≤—ã–ø–ª–∞—Ç –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º:</div>
<div id="payments_results"></div>
</div>
<div class="result-card">
<div class="result-title">–ß–µ–º–ø–∏–æ–Ω–∞—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤:</div>
<div id="championship_results"></div>
</div>

<div class="result-card">
<div class="result-title">–†–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç—Ä–∞—Ç—ã:</div>
<div id="final_strata_calculation"></div>
</div>

<!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ -->
<div class="result-card">
<div class="result-title">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞:</div>
<div class="detailed-calculation" id="detailed_calculation"></div>
</div>

<!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–µ–º–∏–∏ -->
<div class="result-card">
<div class="result-title">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–µ–º–∏–∏:</div>
<div class="premium-structure" id="premium_structure">
<div class="chart-container">
<canvas id="premium-chart" class="premium-chart"></canvas>
<div class="chart-center">
<div class="chart-total" id="chart-total">0 ‚ÇΩ</div>
<div class="chart-percent">100%</div>
</div>
</div>
<div class="chart-legend" id="chart-legend">
<!-- –õ–µ–≥–µ–Ω–¥–∞ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</div>
</div>
</div>
<div class="final-result">
<div>–í–∞—à–∞ –ø—Ä–µ–º–∏—è —Å–æ—Å—Ç–∞–≤–∏—Ç:</div>
<div class="final-amount" id="final_premium">0 ‚ÇΩ</div>
<div>–¥–æ –≤—ã—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤</div>
</div>
</div>
</div>
</div>

<!-- –†–∞–∑–¥–µ–ª –æ—Ç—á–µ—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ú–ü–ü) -->
<div class="tab-content" id="reports-tab">
<div class="calculator-container">
<div class="section reports-section">
<h2 class="section-title"><i class="fas fa-chart-bar"></i> –û—Ç—á–µ—Ç—ã</h2>
<div class="report-type-selector">
<button class="report-type-btn active" data-type="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç</button>
<button class="report-type-btn" data-type="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç</button>
</div>

<!-- –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã -->
<div class="report-form weekly-report active">
<div id="monthly-report-alert" class="alert" style="display: none;">
<i class="fas fa-exclamation-triangle"></i>
<span id="alert-message"></span>
</div>
<div class="reports-form">
<h3>–î–æ–±–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
<div class="form-group">
<label>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–µ–ª—é:</label>
<div class="week-options" id="week-options">
<!-- –ù–µ–¥–µ–ª–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</div>
</div>
<h4>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
<div class="plan-fact-container">
<div>
<label>–ö–í–¶ –∫–ª–∏–µ–Ω—Ç—ã:</label>
<input type="number" id="report-kvc" min="0" max="1000" value="0">
</div>
<div>
<label>–ö–†–• —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–æ:</label>
<input type="number" id="report-krh" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label>–î–ö –æ–±—ä–µ–º (—Ä—É–±.):</label>
<input type="number" id="report-dk-volume" min="0" max="100000000" value="0">
</div>
<div>
<label>–í–∫–ª–∞–¥ –æ–±—ä–µ–º (—Ä—É–±.):</label>
<input type="number" id="report-vklad-volume" min="0" max="100000000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label>–î–ö –∫–æ–ª-–≤–æ (—à—Ç.):</label>
<input type="number" id="report-dk-count" min="0" max="1000" value="0">
</div>
<div>
<label>–í–∫–ª–∞–¥ –∫–æ–ª-–≤–æ (—à—Ç.):</label>
<input type="number" id="report-vklad-count" min="0" max="1000" value="0">
</div>
</div>
<!-- –ö—Ä–µ–¥–∏—Ç—ã –≤ –æ—Ç—á–µ—Ç–∞—Ö -->
<h4>–ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã</h4>
<div id="report-credits-container">
<!-- –ö—Ä–µ–¥–∏—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</div>
<button class="btn" id="report-add-credit-btn">
<i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–µ–¥–∏—Ç –≤ –æ—Ç—á–µ—Ç
</button>
<h4>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã</h4>
<div class="plan-fact-container">
<div>
<label>–°—Ç–∏–∫–µ—Ä—ã:</label>
<input type="number" id="report-sticker-count" min="0" max="1000" value="0">
</div>
<div>
<label>–ü–æ–¥–ø–∏—Å–∫–∏ –≥–æ–¥–æ–≤—ã–µ:</label>
<input type="number" id="report-year-sub-count" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label>–ü–æ–¥–ø–∏—Å–∫–∏ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ:</label>
<input type="number" id="report-month-sub-count" min="0" max="1000" value="0">
</div>
<div>
<label>–ö–†–• –õ–∏–º–∏—Ç:</label>
<input type="number" id="report-krh-limit-count" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label>–ó–ü –∫–∞—Ä—Ç—ã:</label>
<input type="number" id="report-zp-card-count" min="0" max="1000" value="0">
</div>
<div>
<label>–û–ú–ü (—à—Ç.):</label>
<input type="number" id="report-omp-count" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label>–ó–ü –Ω–µ—Ä–µ–∑ (—à—Ç.):</label>
<input type="number" id="report-zp-nerez-count" min="0" max="1000" value="0">
</div>
<div>
<label>–û–±–æ—Ä–æ—Ç –ø–æ –∫–∞—Ä—Ç–∞–º (—Ä—É–±.):</label>
<input type="number" id="report-card-turnover" min="0" max="100000000" value="0">
</div>
</div>
<h4>–ß–µ–º–ø–∏–æ–Ω–∞—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤</h4>
<div class="plan-fact-container">
<div>
<label>–°–ö–ë (–¥–µ–±–µ—Ç–æ–≤—ã–µ —Å 2%):</label>
<input type="number" id="report-skb-count" min="0" max="1000" value="0">
</div>
<div>
<label>–î–æ–∑–≤–æ–Ω—ã CRM:</label>
<input type="number" id="report-crm-calls" min="0" max="1000" value="0">
</div>
</div>
<button class="btn" id="save-weekly-report-btn">
<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç
</button>
</div>
</div>

<!-- –ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –æ—Ç—á–µ—Ç—ã -->
<div class="report-form monthly-report">
<div class="reports-form">
<h3>–î–æ–±–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü</h3>
<div class="form-group">
<label>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü:</label>
<div class="month-selector">
<select id="month-select" class="month-select">
<!-- –ú–µ—Å—è—Ü—ã –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</select>
</div>
</div>
<h4>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
<div class="plan-fact-container">
<div>
<label>–ö–í–¶ –∫–ª–∏–µ–Ω—Ç—ã:</label>
<input type="number" id="monthly-report-kvc" min="0" max="1000" value="0">
</div>
<div>
<label>–ö–†–• —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–æ:</label>
<input type="number" id="monthly-report-krh" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label>–î–ö –æ–±—ä–µ–º (—Ä—É–±.):</label>
<input type="number" id="monthly-report-dk-volume" min="0" max="100000000" value="0">
</div>
<div>
<label>–í–∫–ª–∞–¥ –æ–±—ä–µ–º (—Ä—É–±.):</label>
<input type="number" id="monthly-report-vklad-volume" min="0" max="100000000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label>–î–ö –∫–æ–ª-–≤–æ (—à—Ç.):</label>
<input type="number" id="monthly-report-dk-count" min="0" max="1000" value="0">
</div>
<div>
<label>–í–∫–ª–∞–¥ –∫–æ–ª-–≤–æ (—à—Ç.):</label>
<input type="number" id="monthly-report-vklad-count" min="0" max="1000" value="0">
</div>
</div>
<!-- –ö—Ä–µ–¥–∏—Ç—ã –≤ –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞—Ö -->
<h4>–ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã</h4>
<div id="monthly-report-credits-container">
<!-- –ö—Ä–µ–¥–∏—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</div>
<button class="btn" id="monthly-report-add-credit-btn">
<i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–µ–¥–∏—Ç –≤ –æ—Ç—á–µ—Ç
</button>
<h4>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã</h4>
<div class="plan-fact-container">
<div>
<label>–°—Ç–∏–∫–µ—Ä—ã:</label>
<input type="number" id="monthly-report-sticker-count" min="0" max="1000" value="0">
</div>
<div>
<label>–ü–æ–¥–ø–∏—Å–∫–∏ –≥–æ–¥–æ–≤—ã–µ:</label>
<input type="number" id="monthly-report-year-sub-count" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label>–ü–æ–¥–ø–∏—Å–∫–∏ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ:</label>
<input type="number" id="monthly-report-month-sub-count" min="0" max="1000" value="0">
</div>
<div>
<label>–ö–†–• –õ–∏–º–∏—Ç:</label>
<input type="number" id="monthly-report-krh-limit-count" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label>–ó–ü –∫–∞—Ä—Ç—ã:</label>
<input type="number" id="monthly-report-zp-card-count" min="0" max="1000" value="0">
</div>
<div>
<label>–û–ú–ü (—à—Ç.):</label>
<input type="number" id="monthly-report-omp-count" min="0" max="1000" value="0">
</div>
</div>
<div class="plan-fact-container">
<div>
<label>–ó–ü –Ω–µ—Ä–µ–∑ (—à—Ç.):</label>
<input type="number" id="monthly-report-zp-nerez-count" min="0" max="1000" value="0">
</div>
<div>
<label>–û–±–æ—Ä–æ—Ç –ø–æ –∫–∞—Ä—Ç–∞–º (—Ä—É–±.):</label>
<input type="number" id="monthly-report-card-turnover" min="0" max="100000000" value="0">
</div>
</div>
<h4>–ß–µ–º–ø–∏–æ–Ω–∞—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤</h4>
<div class="plan-fact-container">
<div>
<label>–°–ö–ë (–¥–µ–±–µ—Ç–æ–≤—ã–µ —Å 2%):</label>
<input type="number" id="monthly-report-skb-count" min="0" max="1000" value="0">
</div>
<div>
<label>–î–æ–∑–≤–æ–Ω—ã CRM:</label>
<input type="number" id="monthly-report-crm-calls" min="0" max="1000" value="0">
</div>
</div>

<!-- –ü–æ–ª–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø—Ä–µ–º–∏–∏ -->
<div class="form-group">
<label for="monthly-adjusted-premium">–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–µ–º–∏—è (–º–æ–∂–Ω–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å):</label>
<input type="number" id="monthly-adjusted-premium" min="0" max="1000000" value="0">
</div>

<button class="btn" id="save-monthly-report-btn">
<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç
</button>
</div>
</div>
</div>
</div>
</div>

<!-- –†–∞–∑–¥–µ–ª —Ç–æ–ø–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ú–ü–ü) -->
<div class="tab-content" id="leaderboard-tab">
<div class="calculator-container">
<div class="section leaderboard-section">
<h2 class="section-title"><i class="fas fa-crown"></i> –¢–æ–ø —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h2>
<div class="leaderboard-period-selector">
<button class="period-btn active" data-period="week">–¢–æ–ø –Ω–µ–¥–µ–ª–∏</button>
<button class="period-btn" data-period="month">–¢–æ–ø –º–µ—Å—è—Ü–∞</button>
<button class="period-btn" data-period="last-month">–õ—É—á—à–∏–µ –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</button>
<button class="period-btn" data-period="records">–†–µ–∫–æ—Ä–¥—ã –ø—Ä–æ–¥–∞–∂</button>
</div>

<div id="current-period-leaderboard">
<h3>üèÜ –¢–æ–ø –ø–æ –ø—Ä–µ–º–∏–∏</h3>
<div id="premium-leaderboard">
<!-- –¢–æ–ø –ø–æ –ø—Ä–µ–º–∏–∏ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
</div>
<h3>üìä –¢–æ–ø –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º</h3>
<div id="credits-leaderboard">
<!-- –¢–æ–ø –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
</div>
<h3>üí∞ –¢–æ–ø –ø–æ –≤–∫–ª–∞–¥–∞–º</h3>
<div id="deposits-leaderboard">
<!-- –¢–æ–ø –ø–æ –≤–∫–ª–∞–¥–∞–º –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
</div>
</div>

<div class="last-month-leaderboard" id="last-month-leaderboard" style="display: none;">
<h3>üèÜ –õ—É—á—à–∏–µ –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</h3>
<div id="last-month-premium-leaderboard">
<!-- –¢–æ–ø –ø–æ –ø—Ä–µ–º–∏–∏ –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
</div>
</div>

<!-- –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –†–ï–ö–û–†–î–´ –ü–†–û–î–ê–ñ -->
<div class="records-container" id="records-leaderboard" style="display: none;">
<h3>üèÖ –†–µ–∫–æ—Ä–¥—ã –ø—Ä–æ–¥–∞–∂</h3>

<!-- –§–æ—Ä–º–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) -->
<div class="record-form" id="record-form" style="display: none;">
<div class="record-form-title">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∫–æ—Ä–¥</div>
<div class="record-input-group">
<div class="record-input">
<label for="record-type">–¢–∏–ø —Ä–µ–∫–æ—Ä–¥–∞:</label>
<select id="record-type">
<option value="credits">–ö—Ä–µ–¥–∏—Ç—ã (–∫–æ–ª-–≤–æ)</option>
<option value="deposits">–í–∫–ª–∞–¥—ã (–∫–æ–ª-–≤–æ)</option>
<option value="krh">–°—Ç–∞—Ä—Ç (–∫–æ–ª-–≤–æ)</option>
</select>
</div>
<div class="record-input">
<label for="record-value">–ó–Ω–∞—á–µ–Ω–∏–µ:</label>
<input type="number" id="record-value" min="0" max="1000" value="0">
</div>
</div>

<!-- –ù–û–í–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢ –î–õ–Ø –ü–û–ò–°–ö–ê –°–û–¢–†–£–î–ù–ò–ö–û–í -->
<div class="record-input">
<label for="user-search">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:</label>
<div class="custom-select-wrapper">
<div class="search-input-container">
<input type="text" class="search-input" id="user-search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞...">
<i class="fas fa-search search-icon"></i>
</div>
<div class="search-results" id="user-search-results">
<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
</div>
</div>
<div class="selected-user" id="selected-user" style="display: none;">
–í—ã–±—Ä–∞–Ω: <span id="selected-user-name"></span>
<input type="hidden" id="selected-user-id">
</div>
</div>

<button class="record-btn" id="save-record-btn">
<i class="fas fa-trophy"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∫–æ—Ä–¥
</button>
</div>

<!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–æ–≤ -->
<div class="record-item">
<div class="record-header">
<div class="record-title">–ö—Ä–µ–¥–∏—Ç—ã (–∫–æ–ª-–≤–æ)</div>
<div class="record-value" id="credits-record-value">0</div>
</div>
<div class="record-user" id="credits-record-user">–†–µ–∫–æ—Ä–¥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>
</div>

<div class="record-item">
<div class="record-header">
<div class="record-title">–í–∫–ª–∞–¥—ã (–∫–æ–ª-–≤–æ)</div>
<div class="record-value" id="deposits-record-value">0</div>
</div>
<div class="record-user" id="deposits-record-user">–†–µ–∫–æ—Ä–¥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>
</div>

<div class="record-item">
<div class="record-header">
<div class="record-title">–°—Ç–∞—Ä—Ç (–∫–æ–ª-–≤–æ)</div>
<div class="record-value" id="krh-record-value">0</div>
</div>
<div class="record-user" id="krh-record-user">–†–µ–∫–æ—Ä–¥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>
</div>
</div>
</div>
</div>
</div>

<!-- –†–∞–∑–¥–µ–ª –ø—Ä–æ—Ñ–∏–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –ú–ü–ü) -->
<div class="tab-content" id="profile-tab">
<div class="calculator-container">
<div class="section profile-section">
<h2 class="section-title"><i class="fas fa-user"></i> –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
<div class="profile-stats">
<div class="profile-stat">
<div class="profile-stat-value" id="total-premium">0 ‚ÇΩ</div>
<div class="profile-stat-label">–û–±—â–∞—è –ø—Ä–µ–º–∏—è</div>
</div>
<div class="profile-stat">
<div class="profile-stat-value" id="average-premium">0 ‚ÇΩ</div>
<div class="profile-stat-label">–°—Ä–µ–¥–Ω—è—è –ø—Ä–µ–º–∏—è</div>
</div>
<div class="profile-stat">
<div class="profile-stat-value" id="total-credits">0</div>
<div class="profile-stat-label">–í—Å–µ–≥–æ –∫—Ä–µ–¥–∏—Ç–æ–≤</div>
</div>
<div class="profile-stat">
<div class="profile-stat-value" id="total-deposits">0</div>
<div class="profile-stat-label">–í—Å–µ–≥–æ –≤–∫–ª–∞–¥–æ–≤</div>
</div>
</div>

<div class="premium-history">
<h3>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–º–∏–π</h3>
<div id="premium-history-list">
<!-- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–º–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
</div>
</div>

<h3>–ú–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
<div class="badge-grid" id="badge-grid">
<!-- –ë–µ–π–¥–∂–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</div>
</div>
</div>
</div>

<!-- –ù–û–í–ê–Ø –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ -->
<div class="tab-content" id="admin-tab">
<div class="calculator-container">
<div class="section">
<h2 class="section-title"><i class="fas fa-crown"></i> –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>

<div class="admin-tabs">
<button class="admin-tab active" data-tab="admin-plans">–ü–ª–∞–Ω—ã</button>
<button class="admin-tab" data-tab="admin-changes">–ò–∑–º–µ–Ω–µ–Ω–∏—è</button>
<button class="admin-tab" data-tab="admin-records">–†–µ–∫–æ—Ä–¥—ã</button>
</div>

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞–º–∏ -->
<div class="admin-content active" id="admin-plans">
<div class="section">
<h3 class="section-title"><i class="fas fa-target"></i> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–Ω–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</h3>
<p style="margin-bottom: 15px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–Ω–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è –≤—Å–µ—Ö –ú–ü–ü –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü</p>

<div class="form-group">
<label for="admin-plan-month">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü:</label>
<select id="admin-plan-month" class="month-select">
<!-- –ú–µ—Å—è—Ü—ã –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</select>
</div>

<div class="admin-plans-form">
<div class="plan-input-group">
<div class="plan-input">
<label for="admin-krh-plan">–ö–†–• (–ø–ª–∞–Ω, —à—Ç.):</label>
<input type="number" id="admin-krh-plan" min="0" max="1000" value="14">
</div>
<div class="plan-input">
<label for="admin-vklad-volume-plan">–í–∫–ª–∞–¥ –æ–±—ä–µ–º (–ø–ª–∞–Ω, —Ä—É–±.):</label>
<input type="number" id="admin-vklad-volume-plan" min="0" max="100000000" value="1920000">
</div>
</div>
<div class="plan-input-group">
<div class="plan-input">
<label for="admin-vklad-count-plan">–í–∫–ª–∞–¥—ã (–ø–ª–∞–Ω, —à—Ç.):</label>
<input type="number" id="admin-vklad-count-plan" min="0" max="1000" value="4">
</div>
<div class="plan-input">
<label for="admin-dk-count-plan">–î–ö (–ø–ª–∞–Ω, —à—Ç.):</label>
<input type="number" id="admin-dk-count-plan" min="0" max="1000" value="2">
</div>
</div>
<div class="plan-input-group">
<div class="plan-input">
<label for="admin-dk-volume-plan">–î–ö –æ–±—ä–µ–º (–ø–ª–∞–Ω, —Ä—É–±.):</label>
<input type="number" id="admin-dk-volume-plan" min="0" max="100000000" value="960000">
</div>
<div class="plan-input">
<label for="admin-kvc-plan">–ö–í–¶ (–ø–ª–∞–Ω, –∫–ª–∏–µ–Ω—Ç—ã):</label>
<input type="number" id="admin-kvc-plan" min="0" max="1000" value="30">
</div>
</div>
</div>

<button class="btn" id="save-plans-btn">
<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω—ã
</button>
</div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
<div class="admin-content" id="admin-changes">
<div class="section changes-form">
<h3 class="section-title"><i class="fas fa-exclamation-circle"></i> –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ—Ç–∏–≤–∞—Ü–∏–∏</h3>
<p style="margin-bottom: 15px;">–í–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ—Ç–∏–≤–∞—Ü–∏—é –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞. –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–≤–∏–¥—è—Ç –≤—Å–µ –ú–ü–ü –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä".</p>
<div class="form-group">
<label for="changes-text">–¢–µ–∫—Å—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π:</label>
<textarea id="changes-text" rows="10" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color);"></textarea>
</div>
<button class="btn" id="save-changes-btn">
<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
</button>
</div>
</div>

<!-- –ù–û–í–ê–Ø –í–ö–õ–ê–î–ö–ê: –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–ö–û–†–î–ê–ú–ò -->
<div class="admin-content" id="admin-records">
<div class="section">
<h3 class="section-title"><i class="fas fa-trophy"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–∞–º–∏ –ø—Ä–æ–¥–∞–∂</h3>
<p style="margin-bottom: 15px;">–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–∫–æ—Ä–¥—ã –ø—Ä–æ–¥–∞–∂ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>

<div class="record-form">
<div class="record-form-title">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥</div>
<div class="record-input-group">
<div class="record-input">
<label for="admin-record-type">–¢–∏–ø —Ä–µ–∫–æ—Ä–¥–∞:</label>
<select id="admin-record-type">
<option value="credits">–ö—Ä–µ–¥–∏—Ç—ã (–∫–æ–ª-–≤–æ)</option>
<option value="deposits">–í–∫–ª–∞–¥—ã (–∫–æ–ª-–≤–æ)</option>
<option value="krh">–°—Ç–∞—Ä—Ç (–∫–æ–ª-–≤–æ)</option>
</select>
</div>
<div class="record-input">
<label for="admin-record-value">–ó–Ω–∞—á–µ–Ω–∏–µ:</label>
<input type="number" id="admin-record-value" min="0" max="1000" value="0">
</div>
</div>

<!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ -->
<div class="record-input">
<label for="admin-user-search">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:</label>
<div class="custom-select-wrapper">
<div class="search-input-container">
<input type="text" class="search-input" id="admin-user-search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞...">
<i class="fas fa-search search-icon"></i>
</div>
<div class="search-results" id="admin-user-search-results">
<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
</div>
</div>
<div class="selected-user" id="admin-selected-user" style="display: none;">
–í—ã–±—Ä–∞–Ω: <span id="admin-selected-user-name"></span>
<input type="hidden" id="admin-selected-user-id">
</div>
</div>

<button class="record-btn" id="admin-save-record-btn">
<i class="fas fa-trophy"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∫–æ—Ä–¥
</button>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Ç–µ–∫—É—â–∏—Ö —Ä–µ–∫–æ—Ä–¥–æ–≤ -->
<div class="records-container" style="margin-top: 30px;">
<h3>–¢–µ–∫—É—â–∏–µ —Ä–µ–∫–æ—Ä–¥—ã</h3>
<div class="record-item">
<div class="record-header">
<div class="record-title">–ö—Ä–µ–¥–∏—Ç—ã (–∫–æ–ª-–≤–æ)</div>
<div class="record-value" id="admin-credits-record-value">0</div>
</div>
<div class="record-user" id="admin-credits-record-user">–†–µ–∫–æ—Ä–¥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>
<button class="btn btn-remove" onclick="editRecord('credits')" style="margin-top: 10px;">
<i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å
</button>
</div>

<div class="record-item">
<div class="record-header">
<div class="record-title">–í–∫–ª–∞–¥—ã (–∫–æ–ª-–≤–æ)</div>
<div class="record-value" id="admin-deposits-record-value">0</div>
</div>
<div class="record-user" id="admin-deposits-record-user">–†–µ–∫–æ—Ä–¥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>
<button class="btn btn-remove" onclick="editRecord('deposits')" style="margin-top: 10px;">
<i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å
</button>
</div>

<div class="record-item">
<div class="record-header">
<div class="record-title">–°—Ç–∞—Ä—Ç (–∫–æ–ª-–≤–æ)</div>
<div class="record-value" id="admin-krh-record-value">0</div>
</div>
<div class="record-user" id="admin-krh-record-user">–†–µ–∫–æ—Ä–¥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>
<button class="btn btn-remove" onclick="editRecord('krh')" style="margin-top: 10px;">
<i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å
</button>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã -->
<button class="theme-toggle" id="themeToggle">
<i class="fas fa-moon"></i>
</button>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<div class="nav-tabs">
<a href="#" class="nav-tab active" data-tab="calculator-tab">
<i class="fas fa-calculator"></i>
<span>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</span>
</a>
<a href="#" class="nav-tab" id="reports-nav" data-tab="reports-tab">
<i class="fas fa-chart-bar"></i>
<span>–û—Ç—á–µ—Ç—ã</span>
</a>
<a href="#" class="nav-tab" id="leaderboard-nav" data-tab="leaderboard-tab">
<i class="fas fa-crown"></i>
<span>–¢–æ–ø</span>
</a>
<a href="#" class="nav-tab" id="profile-nav" data-tab="profile-tab">
<i class="fas fa-user"></i>
<span>–ü—Ä–æ—Ñ–∏–ª—å</span>
</a>
<a href="#" class="nav-tab" id="admin-nav" data-tab="admin-tab" style="display: none;">
<i class="fas fa-cog"></i>
<span>–ê–¥–º–∏–Ω</span>
</a>
</div>

<script>
// üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyCdQ8_gViAkfeHvabiHI5n9C9EP7hQW_j4",
  authDomain: "mpp-premium-calculator.firebaseapp.com",
  projectId: "mpp-premium-calculator",
  storageBucket: "mpp-premium-calculator.firebasestorage.app",
  messagingSenderId: "310897873427",
  appId: "1:310897873427:web:f2b65971191ca4359aa5e6"
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
let db = null;
let firebaseInitialized = false;

async function initializeFirebase() {
  try {
    showLoader("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase...");
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    await db.collection('users').limit(1).get();
    firebaseInitialized = true;
    console.log("Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ");
    hideLoader();
    return true;
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
    firebaseInitialized = false;
    hideLoader();
    showError("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ.");
    return false;
  }
}

// –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –°–¢–†–ê–¢ –î–õ–Ø –û–°–ù–û–í–ù–´–• –ü–û–ö–ê–ó–ê–¢–ï–õ–ï–ô
const STRATA_RULES = [
  { min: 120, strata: 1, multiplier: 1.15, points: 1 },
  { min: 110, strata: 2, multiplier: 1.10, points: 2 },
  { min: 100, strata: 3, multiplier: 1.00, points: 3 },
  { min: 90, strata: 4, multiplier: 0.90, points: 4 },
  { min: 80, strata: 5, multiplier: 0.80, points: 5 },
  { min: 70, strata: 6, multiplier: 0.70, points: 6 },
  { min: 60, strata: 7, multiplier: 0.00, points: 7 },
  { min: 50, strata: 8, multiplier: 0.00, points: 8 },
  { min: 40, strata: 9, multiplier: 0.00, points: 9 },
  { min: 30, strata: 10, multiplier: 0.00, points: 10 },
  { min: 0, strata: 20, multiplier: 0.00, points: 20 }
];

// –°–ò–°–¢–ï–ú–ê –ò–¢–û–ì–û–í–´–• –°–¢–†–ê–¢
const FINAL_STRATA_RULES = [
  { min: 49, strata: 20 },
  { min: 39, strata: 10 },
  { min: 35, strata: 9 },
  { min: 31, strata: 8 },
  { min: 27, strata: 7 },
  { min: 23, strata: 6 },
  { min: 19, strata: 5 },
  { min: 15, strata: 4 },
  { min: 11, strata: 3 },
  { min: 6, strata: 2 },
  { min: 1, strata: 1 }
];

// –¢–∏–ø—ã –∫—Ä–µ–¥–∏—Ç–æ–≤ –∏ –∏—Ö —Å—Ç–æ–∏–º–æ—Å—Ç–∏
const CREDIT_TYPES = {
  'zp': { name: '–ó–∞—Ä–ø–ª–∞—Ç–Ω—ã–π', base: 0, packageMultiplier: 1, fzRequired: true },
  'prime': { name: '–ü—Ä–∞–π–º', base: 0, packageMultiplier: 0.5, fzRequired: true },
  'autocredit': { name: '–ê–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç/–î–ö–ü–ó–ê', base: 1250, packageMultiplier: 1, fzRequired: true },
  'ipoteka': { name: '–ò–ø–æ—Ç–µ–∫–∞', base: 7000, packageMultiplier: 0, fzRequired: false },
  'dkpzn': { name: '–î–ö–ü–ó–ù', base: 2000, packageMultiplier: 1, fzRequired: true },
  'mkk_no_fz': { name: '–ú–ö–ö –±–µ–∑ –§–ó', base: 1000, packageMultiplier: 0, fzRequired: false },
  'mkk_with_fz': { name: '–ú–ö–ö —Å –§–ó', base: 1500, packageMultiplier: 0, fzRequired: true },
  'halva_refinance': { name: '–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –•–∞–ª–≤–æ–π', base: 0, packageMultiplier: 0, fzRequired: false }
};

// –ü–∞–∫–µ—Ç—ã –∑–∞—â–∏—Ç—ã
const PACKAGES = [
  { value: 0, name: '–ë–µ–∑ –ø–∞–∫–µ—Ç–∞' },
  { value: 500, name: '–ü–∞–∫–µ—Ç 1 (500‚ÇΩ)' },
  { value: 1400, name: '–ü–∞–∫–µ—Ç 2 (1,400‚ÇΩ)' },
  { value: 1500, name: '–ü–∞–∫–µ—Ç 3 (1,500‚ÇΩ)' },
  { value: 2000, name: '–ü–∞–∫–µ—Ç 4 (2,000‚ÇΩ)' },
  { value: 3400, name: '–ü–∞–∫–µ—Ç 5 (3,400‚ÇΩ)' },
  { value: 4000, name: '–ü–∞–∫–µ—Ç 6 (4,000‚ÇΩ)' },
  { value: 5000, name: '–ü–∞–∫–µ—Ç 7 (5,000‚ÇΩ)' },
  { value: 6000, name: '–ü–∞–∫–µ—Ç 8 (6,000‚ÇΩ)' },
  { value: 7000, name: '–ü–∞–∫–µ—Ç 9 (7,000‚ÇΩ)' },
  { value: 8000, name: '–ü–∞–∫–µ—Ç 10 (8,000‚ÇΩ)' }
];

// –ú–µ—Å—è—Ü—ã –≤ —Ä–æ–¥–∏—Ç–µ–ª—å–Ω–æ–º –ø–∞–¥–µ–∂–µ
const MONTHS_GENITIVE = [
  '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
  '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
];

// –¶–≤–µ—Ç–∞ –¥–ª—è –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã
const CHART_COLORS = [
  '#3498db', // —Å–∏–Ω–∏–π - –∫—Ä–µ–¥–∏—Ç—ã
  '#2ecc71', // –∑–µ–ª–µ–Ω—ã–π - –≤–∫–ª–∞–¥—ã
  '#e74c3c', // –∫—Ä–∞—Å–Ω—ã–π - –ö–†–•
  '#f39c12', // –æ—Ä–∞–Ω–∂–µ–≤—ã–π - –¥–æ–ø. –ø—Ä–æ–¥—É–∫—Ç—ã
  '#9b59b6', // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π - —ç–∫—Å—Ç—Ä–∞–±–æ–Ω—É—Å
  '#1abc9c', // –±–∏—Ä—é–∑–æ–≤—ã–π - –Ω–∞–¥–±–∞–≤–∫–∞ –∑–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—å
  '#34495e', // —Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π - –ø—Ä–æ—á–∏–µ
  '#d35400', // —Ç–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
  '#c0392b', // —Ç–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
  '#7f8c8d' // —Å–µ—Ä—ã–π
];

// üîß –¢–ï–õ–ï–ì–†–ê–ú –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
let tg = null;
let currentUser = null;
let userData = {
  role: 'mpp',
  history: [],
  settings: {},
  monthlyReports: []
};
let creditIds = [];
let reportCreditIds = [];
let monthlyReportCreditIds = [];
let currentTheme = localStorage.getItem('theme') || 'light';
let selectedWeek = null;

// üîß –£–¢–ò–õ–ò–¢–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–†–ò–õ–û–ñ–ï–ù–ò–ï–ú

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
function showLoader(message = "–ó–∞–≥—Ä—É–∑–∫–∞...") {
  const loader = document.getElementById('globalLoader');
  const loaderText = document.querySelector('.loader-text');
  if (loader && loaderText) {
    loaderText.textContent = message;
    loader.style.display = 'flex';
  }
}

function hideLoader() {
  const loader = document.getElementById('globalLoader');
  if (loader) {
    loader.style.display = 'none';
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
function showError(message) {
  const errorElement = document.getElementById('errorMessage');
  if (errorElement) {
    errorElement.textContent = message;
    errorElement.style.display = 'block';
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      errorElement.style.display = 'none';
    }, 5000);
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
function showSuccess(message) {
  const successElement = document.getElementById('successMessage');
  if (successElement) {
    successElement.textContent = message;
    successElement.style.display = 'block';
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      successElement.style.display = 'none';
    }, 3000);
  }
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
function validateInput(value, min = 0, max = 1000000) {
  const num = parseInt(value);
  if (isNaN(num) || num < min) return min;
  if (num > max) return max;
  return num;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
function checkAdminRights() {
  return userData.role === 'admin' && currentUser && currentUser.id !== 'demo';
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
window.addEventListener('error', function(e) {
  console.error('Global error:', e);
  showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏');
});

window.addEventListener('unhandledrejection', function(e) {
  console.error('Unhandled promise rejection:', e);
  showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏: ' + e.reason);
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞–Ω–∞–º–∏
function getDefaultPlans() {
  return {
    krh_plan: 14,
    vklad_volume_plan: 1920000,
    vklad_count_plan: 4,
    dk_count_plan: 2,
    dk_volume_plan: 960000,
    kvc_plan: 30
  };
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
async function getPlansForMonth(monthKey) {
  if (!firebaseInitialized) {
    return getDefaultPlans();
  }

  try {
    const plansDoc = await db.collection('plans').doc(monthKey).get();
    if (plansDoc.exists) {
      return plansDoc.data();
    } else {
      return getDefaultPlans();
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–Ω–æ–≤:', error);
    return getDefaultPlans();
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–æ–≤ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
async function loadPlansIntoCalculator() {
  const now = new Date();
  const currentMonthKey = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
  
  try {
    const plans = await getPlansForMonth(currentMonthKey);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–∞–Ω—ã –≤ –ø–æ–ª—è –≤–≤–æ–¥–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    document.getElementById('krh_plan').value = plans.krh_plan;
    document.getElementById('vklad_volume_plan').value = plans.vklad_volume_plan;
    document.getElementById('vklad_count_plan').value = plans.vklad_count_plan;
    document.getElementById('dk_count_plan').value = plans.dk_count_plan;
    document.getElementById('dk_volume_plan').value = plans.dk_volume_plan;
    document.getElementById('kvc_plan').value = plans.kvc_plan;
    
    console.log("–ü–ª–∞–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä:", plans);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–Ω–æ–≤ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä:', error);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏
async function loadMotivationChanges() {
  if (!firebaseInitialized) return;
  
  try {
    const now = new Date();
    const currentMonthKey = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
    
    const changesDoc = await db.collection('motivation_changes').doc(currentMonthKey).get();
    
    if (changesDoc.exists) {
      const changesData = changesDoc.data();
      const notificationElement = document.getElementById('motivation-changes-notification');
      const contentElement = document.getElementById('motivation-changes-content');
      const dateElement = document.getElementById('motivation-changes-date');
      
      if (changesData.text && changesData.text.trim() !== '') {
        contentElement.innerHTML = changesData.text.replace(/\n/g, '<br>');
        dateElement.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(changesData.updatedAt?.toDate()).toLocaleDateString('ru-RU')}`;
        notificationElement.style.display = 'block';
      } else {
        notificationElement.style.display = 'none';
      }
    } else {
      document.getElementById('motivation-changes-notification').style.display = 'none';
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏:', error);
    document.getElementById('motivation-changes-notification').style.display = 'none';
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
async function loadAdminMotivationChanges() {
  if (!firebaseInitialized) return;
  
  try {
    const now = new Date();
    const currentMonthKey = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
    
    const changesDoc = await db.collection('motivation_changes').doc(currentMonthKey).get();
    
    if (changesDoc.exists) {
      const changesData = changesDoc.data();
      document.getElementById('changes-text').value = changesData.text || '';
    } else {
      document.getElementById('changes-text').value = '';
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:', error);
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏
async function saveMotivationChanges() {
  if (!checkAdminRights()) {
    showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
    return;
  }
  
  if (!firebaseInitialized) return;
  
  try {
    showLoader("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π...");
    
    const now = new Date();
    const currentMonthKey = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
    const changesText = document.getElementById('changes-text').value;
    
    await db.collection('motivation_changes').doc(currentMonthKey).set({
      text: changesText,
      monthKey: currentMonthKey,
      updatedBy: currentUser.id,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    hideLoader();
    showSuccess('–ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    await loadMotivationChanges();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:', error);
    hideLoader();
    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π');
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
async function initTelegram() {
  try {
    tg = window.Telegram.WebApp;
    tg.expand();
    console.log("Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    
    const user = tg.initDataUnsafe.user;
    if (user) {
      currentUser = {
        id: user.id,
        firstName: user.first_name,
        lastName: user.last_name || '',
        username: user.username
      };
      showUserInfo();
      await loadUserData();
    } else {
      currentUser = {
        id: 'demo',
        firstName: '–î–µ–º–æ',
        lastName: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
      };
      showUserInfo();
      initializeApp();
    }
    
    if (tg.colorScheme === 'dark') {
      currentTheme = 'dark';
      document.documentElement.setAttribute('data-theme', 'dark');
    } else {
      currentTheme = 'light';
      document.documentElement.setAttribute('data-theme', 'light');
    }
    updateThemeIcon();
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram:", error);
    currentUser = {
      id: 'demo',
      firstName: '–î–µ–º–æ',
      lastName: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
    };
    showUserInfo();
    initializeApp();
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function showUserInfo() {
  const userAvatar = document.getElementById('userAvatar');
  const userName = document.getElementById('userName');
  const userRole = document.getElementById('userRole');
  
  const displayName = currentUser.firstName + (currentUser.lastName ? ' ' + currentUser.lastName : '');
  const firstLetter = currentUser.firstName ? currentUser.firstName.charAt(0).toUpperCase() : 'U';
  
  userAvatar.textContent = firstLetter;
  userName.textContent = displayName;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
async function initializeApp() {
  document.querySelector('.container').style.display = 'block';
  document.querySelector('.nav-tabs').style.display = 'flex';
  document.querySelector('.theme-toggle').style.display = 'flex';
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
  setupNavigation();
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤–≤–æ–¥–∞
  setupInputValidation();
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞–Ω—ã –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
  await loadPlansIntoCalculator();
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ—Ç–∏–≤–∞—Ü–∏–∏
  await loadMotivationChanges();
  
  initializeMPPCalculator();
  initializeReports();
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Ç–æ–ª—å–∫–æ –¥–ª—è –ú–ü–ü
  if (!checkAdminRights()) {
    await loadProfile();
  }
  
  loadWeekOptions();
  loadMonthOptions();
  
  if (!checkAdminRights()) {
    await loadLeaderboard('week');
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞
  if (checkAdminRights()) {
    await initializeAdminPanel();
  }
  
  addCredit();
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
function setupNavigation() {
  const isAdmin = checkAdminRights();
  
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ —Å–Ω–∞—á–∞–ª–∞
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.style.display = 'none';
  });
  
  if (isAdmin) {
    // –ê–î–ú–ò–ù –í–ò–î–ò–¢ –í–°–ï –í–ö–õ–ê–î–ö–ò, –í–ö–õ–Æ–ß–ê–Ø –¢–û–ü
    document.getElementById('admin-nav').style.display = 'flex';
    document.querySelector('[data-tab="calculator-tab"]').style.display = 'flex';
    document.getElementById('leaderboard-nav').style.display = 'flex'; // –í–ö–õ–Æ–ß–ê–ï–ú –¢–û–ü –î–õ–Ø –ê–î–ú–ò–ù–ê
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –æ—Ç—á–µ—Ç–æ–≤ –∏ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    document.getElementById('reports-nav').style.display = 'none';
    document.getElementById('profile-nav').style.display = 'none';
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.querySelector('.nav-tab.active')?.classList.remove('active');
    document.querySelector('.tab-content.active')?.classList.remove('active');
    document.querySelector('[data-tab="calculator-tab"]').classList.add('active');
    document.getElementById('calculator-tab').classList.add('active');
  } else {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –ú–ü–ü
    document.querySelector('[data-tab="calculator-tab"]').style.display = 'flex';
    document.querySelector('[data-tab="reports-tab"]').style.display = 'flex';
    document.querySelector('[data-tab="leaderboard-tab"]').style.display = 'flex';
    document.querySelector('[data-tab="profile-tab"]').style.display = 'flex';
  }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤–≤–æ–¥–∞
function setupInputValidation() {
  document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('change', function() {
      const min = parseInt(this.getAttribute('min')) || 0;
      const max = parseInt(this.getAttribute('max')) || 1000000;
      this.value = validateInput(this.value, min, max);
    });
    
    input.addEventListener('input', function() {
      const min = parseInt(this.getAttribute('min')) || 0;
      const max = parseInt(this.getAttribute('max')) || 1000000;
      const value = parseInt(this.value);
      
      if (!isNaN(value) && (value < min || value > max)) {
        this.style.borderColor = 'var(--accent)';
      } else {
        this.style.borderColor = 'var(--border-color)';
      }
    });
  });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function loadUserData() {
  if (!currentUser || currentUser.id === 'demo' || !firebaseInitialized) {
    initializeApp();
    return;
  }

  try {
    showLoader("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...");
    const userDoc = await db.collection('users').doc(String(currentUser.id)).get();
    if (userDoc.exists) {
      const data = userDoc.data();
      userData.role = data.role || 'mpp';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–æ–ª–∏
      const userRole = document.getElementById('userRole');
      userRole.textContent = userData.role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ú–ü–ü';
      if (userData.role === 'admin') {
        userRole.style.color = '#e74c3c';
        userRole.style.fontWeight = 'bold';
      }
      
      await db.collection('users').doc(String(currentUser.id)).set({
        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    } else {
      await db.collection('users').doc(String(currentUser.id)).set({
        telegramUserId: currentUser.id,
        firstName: currentUser.firstName,
        lastName: currentUser.lastName,
        username: currentUser.username,
        role: 'mpp',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      
      userData.role = 'mpp';
    }
    hideLoader();
    initializeApp();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    hideLoader();
    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    initializeApp();
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –Ω–µ–¥–µ–ª—å –º–µ—Å—è—Ü–∞
function getWorkWeeks(year, month) {
  const weeks = [];
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  
  let currentDate = new Date(firstDay);
  while (currentDate.getDay() !== 1 && currentDate <= lastDay) {
    currentDate.setDate(currentDate.getDate() + 1);
  }
  
  if (currentDate > lastDay) {
    currentDate = new Date(firstDay);
  }
  
  while (currentDate <= lastDay) {
    const weekStart = new Date(currentDate);
    let weekEnd = new Date(currentDate);
    weekEnd.setDate(weekEnd.getDate() + 6);
    
    if (weekEnd > lastDay) {
      weekEnd = new Date(lastDay);
    }
    
    weeks.push({
      start: new Date(weekStart),
      end: new Date(weekEnd)
    });
    
    currentDate.setDate(currentDate.getDate() + 7);
  }
  return weeks;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—Ü–∏–π –Ω–µ–¥–µ–ª—å –¥–ª—è –≤—ã–±–æ—Ä–∞
function loadWeekOptions() {
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  const weeks = getWorkWeeks(currentYear, currentMonth);
  const weekOptions = document.getElementById('week-options');
  weekOptions.innerHTML = '';
  
  weeks.forEach((week, index) => {
    const weekElement = document.createElement('div');
    weekElement.className = 'week-option';
    weekElement.innerHTML = `
      <div class="week-range">–ù–µ–¥–µ–ª—è ${index + 1}: ${formatDate(week.start)} - ${formatDate(week.end)}</div>
      <div class="week-days">${getWeekDays(week.start, week.end)}</div>
    `;
    weekElement.addEventListener('click', () => {
      document.querySelectorAll('.week-option').forEach(opt => opt.classList.remove('selected'));
      weekElement.classList.add('selected');
      selectedWeek = week;
    });
    weekOptions.appendChild(weekElement);
  });
  
  if (weeks.length > 0) {
    weekOptions.firstChild.click();
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—Ü–∏–π –º–µ—Å—è—Ü–µ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
function loadMonthOptions() {
  const monthSelect = document.getElementById('month-select');
  const today = new Date();
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth() + 1; // 1-12
  
  monthSelect.innerHTML = '';
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 12 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –º–µ—Å—è—Ü–µ–≤ (—Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –∏ 11 –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö)
  for (let i = 0; i < 12; i++) {
    let year = currentYear;
    let month = currentMonth - i;
    
    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≥–æ–¥ –∏ –º–µ—Å—è—Ü –µ—Å–ª–∏ –º–µ—Å—è—Ü –º–µ–Ω—å—à–µ 1
    if (month < 1) {
      month += 12;
      year -= 1;
    }
    
    const monthDate = new Date(year, month - 1, 1);
    const option = document.createElement('option');
    option.value = `${year}-${month.toString().padStart(2, '0')}`;
    option.textContent = `${MONTHS_GENITIVE[month - 1]} ${year}`;
    
    // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü, –ø–æ–º–µ—á–∞–µ–º –µ–≥–æ –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–π
    if (i === 0) {
      option.selected = true;
    }
    
    monthSelect.appendChild(option);
  }
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
function formatDate(date) {
  return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'numeric' });
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
function getWeekDays(start, end) {
  const days = [];
  const current = new Date(start);
  while (current <= end) {
    days.push(current.toLocaleDateString('ru-RU', { weekday: 'short' }));
    current.setDate(current.getDate() + 1);
  }
  return days.join(', ');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –¥–ª—è –ú–ü–ü
function initializeMPPCalculator() {
  document.getElementById('add-credit-btn').addEventListener('click', addCredit);
  document.getElementById('calculate-btn').addEventListener('click', calculatePremium);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤
function initializeReports() {
  document.getElementById('save-weekly-report-btn').addEventListener('click', saveWeeklyReport);
  document.getElementById('report-add-credit-btn').addEventListener('click', addReportCredit);
  document.getElementById('save-monthly-report-btn').addEventListener('click', saveMonthlyReport);
  document.getElementById('monthly-report-add-credit-btn').addEventListener('click', addMonthlyReportCredit);
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞
  document.querySelectorAll('.report-type-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.report-type-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.report-form').forEach(f => f.classList.remove('active'));
      
      this.classList.add('active');
      const reportType = this.getAttribute('data-type');
      document.querySelector(`.${reportType}-report`).classList.add('active');
    });
  });
}

// üîß –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã
function initTheme() {
  document.documentElement.setAttribute('data-theme', currentTheme);
  updateThemeIcon();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ —Ç–µ–º—ã
function updateThemeIcon() {
  const themeIcon = document.querySelector('#themeToggle i');
  if (themeIcon) {
    themeIcon.className = currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
function toggleTheme() {
  currentTheme = currentTheme === 'light' ? 'dark' : 'light';
  localStorage.setItem('theme', currentTheme);
  initTheme();
}

// üîß –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–†–ï–î–ò–¢–ê–ú–ò (–ú–ü–ü)

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞
function addCredit() {
  const creditId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
  creditIds.push(creditId);
  const container = document.getElementById('credits-container');
  const creditRow = document.createElement('div');
  creditRow.className = 'credit-row';
  creditRow.id = `credit-${creditId}`;
  creditRow.innerHTML = `
    <div>
      <label>–¢–∏–ø –∫—Ä–µ–¥–∏—Ç–∞:</label>
      <select id="credit-type-${creditId}" class="credit-type">
        <option value="zp">–ó–∞—Ä–ø–ª–∞—Ç–Ω—ã–π</option>
        <option value="prime">–ü—Ä–∞–π–º</option>
        <option value="autocredit">–ê–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç/–î–ö–ü–ó–ê</option>
        <option value="ipoteka">–ò–ø–æ—Ç–µ–∫–∞</option>
        <option value="dkpzn">–î–ö–ü–ó–ù</option>
        <option value="mkk_no_fz">–ú–ö–ö –±–µ–∑ –§–ó</option>
        <option value="mkk_with_fz">–ú–ö–ö —Å –§–ó</option>
        <option value="halva_refinance">–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –•–∞–ª–≤–æ–π</option>
      </select>
    </div>
    <div>
      <label>–ü–∞–∫–µ—Ç –∑–∞—â–∏—Ç—ã:</label>
      <select id="credit-package-${creditId}" class="credit-package">
        ${PACKAGES.map(pkg => `<option value="${pkg.value}">${pkg.name}</option>`).join('')}
      </select>
    </div>
    <div>
      <label>–§–ó:</label>
      <select id="credit-fz-${creditId}" class="credit-fz">
        <option value="true">–î–∞</option>
        <option value="false">–ù–µ—Ç</option>
      </select>
    </div>
    <div>
      <label>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ (‚ÇΩ):</label>
      <input type="number" id="credit-amount-${creditId}" min="0" max="100000000" value="0" class="credit-amount">
    </div>
    <div>
      <label>–ü—Ä–µ–º–∏—è:</label>
      <input type="text" id="credit-premium-${creditId}" readonly>
    </div>
    <div>
      <label>&nbsp;</label>
      <button class="btn btn-remove remove-credit" data-id="${creditId}">
        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
      </button>
    </div>
  `;
  container.appendChild(creditRow);
  
  const typeSelect = document.getElementById(`credit-type-${creditId}`);
  const packageSelect = document.getElementById(`credit-package-${creditId}`);
  const fzSelect = document.getElementById(`credit-fz-${creditId}`);
  const amountInput = document.getElementById(`credit-amount-${creditId}`);
  const removeBtn = document.querySelector(`.remove-credit[data-id="${creditId}"]`);
  
  typeSelect.addEventListener('change', () => updateCreditPremium(creditId));
  packageSelect.addEventListener('change', () => updateCreditPremium(creditId));
  fzSelect.addEventListener('change', () => updateCreditPremium(creditId));
  amountInput.addEventListener('input', () => {
    amountInput.value = validateInput(amountInput.value, 0, 100000000);
    updateCreditPremium(creditId);
    updateDKIndicators();
  });
  
  removeBtn.addEventListener('click', function() {
    const creditIdToRemove = this.getAttribute('data-id');
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫—Ä–µ–¥–∏—Ç?')) {
      removeCredit(creditIdToRemove);
    }
  });
  
  updateCreditPremium(creditId);
  updateDKIndicators();
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞ –≤ –æ—Ç—á–µ—Ç
function addReportCredit() {
  const creditId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
  reportCreditIds.push(creditId);
  const container = document.getElementById('report-credits-container');
  const creditRow = document.createElement('div');
  creditRow.className = 'credit-row';
  creditRow.id = `report-credit-${creditId}`;
  creditRow.innerHTML = `
    <div>
      <label>–¢–∏–ø –∫—Ä–µ–¥–∏—Ç–∞:</label>
      <select id="report-credit-type-${creditId}" class="report-credit-type">
        <option value="zp">–ó–∞—Ä–ø–ª–∞—Ç–Ω—ã–π</option>
        <option value="prime">–ü—Ä–∞–π–º</option>
        <option value="autocredit">–ê–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç/–î–ö–ü–ó–ê</option>
        <option value="ipoteka">–ò–ø–æ—Ç–µ–∫–∞</option>
        <option value="dkpzn">–î–ö–ü–ó–ù</option>
        <option value="mkk_no_fz">–ú–ö–ö –±–µ–∑ –§–ó</option>
        <option value="mkk_with_fz">–ú–ö–ö —Å –§–ó</option>
        <option value="halva_refinance">–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –•–∞–ª–≤–æ–π</option>
      </select>
    </div>
    <div>
      <label>–ü–∞–∫–µ—Ç –∑–∞—â–∏—Ç—ã:</label>
      <select id="report-credit-package-${creditId}" class="report-credit-package">
        ${PACKAGES.map(pkg => `<option value="${pkg.value}">${pkg.name}</option>`).join('')}
      </select>
    </div>
    <div>
      <label>–§–ó:</label>
      <select id="report-credit-fz-${creditId}" class="report-credit-fz">
        <option value="true">–î–∞</option>
        <option value="false">–ù–µ—Ç</option>
      </select>
    </div>
    <div>
      <label>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ (‚ÇΩ):</label>
      <input type="number" id="report-credit-amount-${creditId}" min="0" max="100000000" value="0" class="report-credit-amount">
    </div>
    <div>
      <label>–ü—Ä–µ–º–∏—è:</label>
      <input type="text" id="report-credit-premium-${creditId}" readonly>
    </div>
    <div>
      <label>&nbsp;</label>
      <button class="btn btn-remove remove-report-credit" data-id="${creditId}">
        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
      </button>
    </div>
  `;
  container.appendChild(creditRow);
  
  const typeSelect = document.getElementById(`report-credit-type-${creditId}`);
  const packageSelect = document.getElementById(`report-credit-package-${creditId}`);
  const fzSelect = document.getElementById(`report-credit-fz-${creditId}`);
  const amountInput = document.getElementById(`report-credit-amount-${creditId}`);
  const removeBtn = document.querySelector(`.remove-report-credit[data-id="${creditId}"]`);
  
  typeSelect.addEventListener('change', () => updateReportCreditPremium(creditId));
  packageSelect.addEventListener('change', () => updateReportCreditPremium(creditId));
  fzSelect.addEventListener('change', () => updateReportCreditPremium(creditId));
  amountInput.addEventListener('input', () => {
    amountInput.value = validateInput(amountInput.value, 0, 100000000);
    updateReportCreditPremium(creditId);
  });
  
  removeBtn.addEventListener('click', function() {
    const creditIdToRemove = this.getAttribute('data-id');
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫—Ä–µ–¥–∏—Ç?')) {
      removeReportCredit(creditIdToRemove);
    }
  });
  
  updateReportCreditPremium(creditId);
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞ –≤ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç
function addMonthlyReportCredit() {
  const creditId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
  monthlyReportCreditIds.push(creditId);
  const container = document.getElementById('monthly-report-credits-container');
  const creditRow = document.createElement('div');
  creditRow.className = 'credit-row';
  creditRow.id = `monthly-report-credit-${creditId}`;
  creditRow.innerHTML = `
    <div>
      <label>–¢–∏–ø –∫—Ä–µ–¥–∏—Ç–∞:</label>
      <select id="monthly-report-credit-type-${creditId}" class="monthly-report-credit-type">
        <option value="zp">–ó–∞—Ä–ø–ª–∞—Ç–Ω—ã–π</option>
        <option value="prime">–ü—Ä–∞–π–º</option>
        <option value="autocredit">–ê–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç/–î–ö–ü–ó–ê</option>
        <option value="ipoteka">–ò–ø–æ—Ç–µ–∫–∞</option>
        <option value="dkpzn">–î–ö–ü–ó–ù</option>
        <option value="mkk_no_fz">–ú–ö–ö –±–µ–∑ –§–ó</option>
        <option value="mkk_with_fz">–ú–ö–ö —Å –§–ó</option>
        <option value="halva_refinance">–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –•–∞–ª–≤–æ–π</option>
      </select>
    </div>
    <div>
      <label>–ü–∞–∫–µ—Ç –∑–∞—â–∏—Ç—ã:</label>
      <select id="monthly-report-credit-package-${creditId}" class="monthly-report-credit-package">
        ${PACKAGES.map(pkg => `<option value="${pkg.value}">${pkg.name}</option>`).join('')}
      </select>
    </div>
    <div>
      <label>–§–ó:</label>
      <select id="monthly-report-credit-fz-${creditId}" class="monthly-report-credit-fz">
        <option value="true">–î–∞</option>
        <option value="false">–ù–µ—Ç</option>
      </select>
    </div>
    <div>
      <label>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ (‚ÇΩ):</label>
      <input type="number" id="monthly-report-credit-amount-${creditId}" min="0" max="100000000" value="0" class="monthly-report-credit-amount">
    </div>
    <div>
      <label>–ü—Ä–µ–º–∏—è:</label>
      <input type="text" id="monthly-report-credit-premium-${creditId}" readonly>
    </div>
    <div>
      <label>&nbsp;</label>
      <button class="btn btn-remove remove-monthly-report-credit" data-id="${creditId}">
        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
      </button>
    </div>
  `;
  container.appendChild(creditRow);
  
  const typeSelect = document.getElementById(`monthly-report-credit-type-${creditId}`);
  const packageSelect = document.getElementById(`monthly-report-credit-package-${creditId}`);
  const fzSelect = document.getElementById(`monthly-report-credit-fz-${creditId}`);
  const amountInput = document.getElementById(`monthly-report-credit-amount-${creditId}`);
  const removeBtn = document.querySelector(`.remove-monthly-report-credit[data-id="${creditId}"]`);
  
  typeSelect.addEventListener('change', () => updateMonthlyReportCreditPremium(creditId));
  packageSelect.addEventListener('change', () => updateMonthlyReportCreditPremium(creditId));
  fzSelect.addEventListener('change', () => updateMonthlyReportCreditPremium(creditId));
  amountInput.addEventListener('input', () => {
    amountInput.value = validateInput(amountInput.value, 0, 100000000);
    updateMonthlyReportCreditPremium(creditId);
  });
  
  removeBtn.addEventListener('click', function() {
    const creditIdToRemove = this.getAttribute('data-id');
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫—Ä–µ–¥–∏—Ç?')) {
      removeMonthlyReportCredit(creditIdToRemove);
    }
  });
  
  updateMonthlyReportCreditPremium(creditId);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–º–∏–∏ –∑–∞ –∫—Ä–µ–¥–∏—Ç
function updateCreditPremium(id) {
  const typeSelect = document.getElementById(`credit-type-${id}`);
  const packageSelect = document.getElementById(`credit-package-${id}`);
  const fzSelect = document.getElementById(`credit-fz-${id}`);
  const amountInput = document.getElementById(`credit-amount-${id}`);
  const premiumInput = document.getElementById(`credit-premium-${id}`);
  
  if (typeSelect && packageSelect && fzSelect && amountInput && premiumInput) {
    const creditType = typeSelect.value;
    const packageValue = parseInt(packageSelect.value) || 0;
    const hasFZ = fzSelect.value === 'true';
    const creditAmount = parseInt(amountInput.value) || 0;
    const creditConfig = CREDIT_TYPES[creditType];
    
    let creditSum = creditConfig.base;
    
    if (creditType === 'prime') {
      creditSum += Math.min(creditAmount * 0.005, 5000);
    }
    
    if (creditType === 'halva_refinance') {
      creditSum = Math.min(creditAmount * 0.03, 600);
    }
    
    creditSum += packageValue * creditConfig.packageMultiplier;
    
    if (!hasFZ && creditConfig.fzRequired) {
      creditSum = 0;
    }
    
    premiumInput.value = creditSum.toLocaleString() + ' ‚ÇΩ';
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–º–∏–∏ –∑–∞ –∫—Ä–µ–¥–∏—Ç –≤ –æ—Ç—á–µ—Ç–µ
function updateReportCreditPremium(id) {
  const typeSelect = document.getElementById(`report-credit-type-${id}`);
  const packageSelect = document.getElementById(`report-credit-package-${id}`);
  const fzSelect = document.getElementById(`report-credit-fz-${id}`);
  const amountInput = document.getElementById(`report-credit-amount-${id}`);
  const premiumInput = document.getElementById(`report-credit-premium-${id}`);
  
  if (typeSelect && packageSelect && fzSelect && amountInput && premiumInput) {
    const creditType = typeSelect.value;
    const packageValue = parseInt(packageSelect.value) || 0;
    const hasFZ = fzSelect.value === 'true';
    const creditAmount = parseInt(amountInput.value) || 0;
    const creditConfig = CREDIT_TYPES[creditType];
    
    let creditSum = creditConfig.base;
    
    if (creditType === 'prime') {
      creditSum += Math.min(creditAmount * 0.005, 5000);
    }
    
    if (creditType === 'halva_refinance') {
      creditSum = Math.min(creditAmount * 0.03, 600);
    }
    
    creditSum += packageValue * creditConfig.packageMultiplier;
    
    if (!hasFZ && creditConfig.fzRequired) {
      creditSum = 0;
    }
    
    premiumInput.value = creditSum.toLocaleString() + ' ‚ÇΩ';
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–º–∏–∏ –∑–∞ –∫—Ä–µ–¥–∏—Ç –≤ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–º –æ—Ç—á–µ—Ç–µ
function updateMonthlyReportCreditPremium(id) {
  const typeSelect = document.getElementById(`monthly-report-credit-type-${id}`);
  const packageSelect = document.getElementById(`monthly-report-credit-package-${id}`);
  const fzSelect = document.getElementById(`monthly-report-credit-fz-${id}`);
  const amountInput = document.getElementById(`monthly-report-credit-amount-${id}`);
  const premiumInput = document.getElementById(`monthly-report-credit-premium-${id}`);
  
  if (typeSelect && packageSelect && fzSelect && amountInput && premiumInput) {
    const creditType = typeSelect.value;
    const packageValue = parseInt(packageSelect.value) || 0;
    const hasFZ = fzSelect.value === 'true';
    const creditAmount = parseInt(amountInput.value) || 0;
    const creditConfig = CREDIT_TYPES[creditType];
    
    let creditSum = creditConfig.base;
    
    if (creditType === 'prime') {
      creditSum += Math.min(creditAmount * 0.005, 5000);
    }
    
    if (creditType === 'halva_refinance') {
      creditSum = Math.min(creditAmount * 0.03, 600);
    }
    
    creditSum += packageValue * creditConfig.packageMultiplier;
    
    if (!hasFZ && creditConfig.fzRequired) {
      creditSum = 0;
    }
    
    premiumInput.value = creditSum.toLocaleString() + ' ‚ÇΩ';
  }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞
function removeCredit(id) {
  const creditRow = document.getElementById(`credit-${id}`);
  if (creditRow) {
    creditRow.remove();
    creditIds = creditIds.filter(creditId => creditId !== id);
    updateDKIndicators();
  }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞ –∏–∑ –æ—Ç—á–µ—Ç–∞
function removeReportCredit(id) {
  const creditRow = document.getElementById(`report-credit-${id}`);
  if (creditRow) {
    creditRow.remove();
    reportCreditIds = reportCreditIds.filter(creditId => creditId !== id);
  }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞ –∏–∑ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
function removeMonthlyReportCredit(id) {
  const creditRow = document.getElementById(`monthly-report-credit-${id}`);
  if (creditRow) {
    creditRow.remove();
    monthlyReportCreditIds = monthlyReportCreditIds.filter(creditId => creditId !== id);
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –î–ö
function updateDKIndicators() {
  let totalCreditAmount = 0;
  const creditAmountInputs = document.querySelectorAll('.credit-amount');
  creditAmountInputs.forEach(input => {
    const creditAmount = parseInt(input.value) || 0;
    if (creditAmount > 0) {
      totalCreditAmount += creditAmount;
    }
  });
  document.getElementById('dk_volume_fact').value = totalCreditAmount;
}

// üîß –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–°–ß–ï–¢–ê –ü–†–ï–ú–ò–ò (–ú–ü–ü)

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç—ã –∏ –º–Ω–æ–∂–∏—Ç–µ–ª—è –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
function getStrataByPercent(percent) {
  for (let rule of STRATA_RULES) {
    if (percent >= rule.min) {
      return rule;
    }
  }
  return STRATA_RULES[STRATA_RULES.length - 1];
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç—Ä–∞—Ç—ã –ø–æ –±–∞–ª–ª–∞–º
function getFinalStrata(points) {
  for (let rule of FINAL_STRATA_RULES) {
    if (points >= rule.min) {
      return rule.strata;
    }
  }
  return 20;
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã
function drawPremiumPieChart(data) {
  const canvas = document.getElementById('premium-chart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const container = canvas.parentElement;
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
  canvas.width = container.offsetWidth;
  canvas.height = container.offsetHeight;
  
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const radius = Math.min(centerX, centerY) - 10;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  if (!data || data.length === 0 || data.reduce((sum, item) => sum + item.value, 0) === 0) {
    ctx.fillStyle = '#f0f0f0';
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fill();
    ctx.fillStyle = '#999';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = '14px Arial';
    ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', centerX, centerY);
    return;
  }
  
  const total = data.reduce((sum, item) => sum + item.value, 0);
  let startAngle = 0;
  
  data.forEach((item, index) => {
    const sliceAngle = (item.value / total) * 2 * Math.PI;
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = item.color;
    ctx.fill();
    startAngle += sliceAngle;
  });
  
  document.getElementById('chart-total').textContent = Math.round(total).toLocaleString() + ' ‚ÇΩ';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ–≥–µ–Ω–¥—ã –¥–∏–∞–≥—Ä–∞–º–º—ã
function updateChartLegend(data) {
  const legendContainer = document.getElementById('chart-legend');
  const total = data.reduce((sum, item) => sum + item.value, 0);
  
  legendContainer.innerHTML = data.map((item, index) => {
    const percentage = total > 0 ? Math.round((item.value / total) * 100) : 0;
    return `
      <div class="legend-item">
        <div class="legend-color" style="background-color: ${item.color};"></div>
        <div class="legend-label">${item.label}</div>
        <div class="legend-value">${Math.round(item.value).toLocaleString()} ‚ÇΩ (${percentage}%)</div>
      </div>
    `;
  }).join('');
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–µ–º–∏–∏
async function calculatePremium() {
  try {
    showLoader("–†–∞—Å—á–µ—Ç –ø—Ä–µ–º–∏–∏...");
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    const now = new Date();
    const currentMonthKey = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
    const currentPlans = await getPlansForMonth(currentMonthKey);
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–∞–Ω—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤–º–µ—Å—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
    const krhPlan = currentPlans.krh_plan;
    const vkladVolumePlan = currentPlans.vklad_volume_plan;
    const vkladCountPlan = currentPlans.vklad_count_plan;
    const dkCountPlan = currentPlans.dk_count_plan;
    const dkVolumePlan = currentPlans.dk_volume_plan;
    const kvcPlan = currentPlans.kvc_plan;

    // –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –±–µ—Ä–µ–º –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
    const krhFact = validateInput(document.getElementById('krh_fact').value, 0, 1000);
    const krhPercent = krhPlan > 0 ? Math.round((krhFact / krhPlan) * 100) : (krhFact > 0 ? 100 : 0);

    const vkladVolumeFact = validateInput(document.getElementById('vklad_volume_fact').value, 0, 100000000);
    const vkladVolumePercent = vkladVolumePlan > 0 ? Math.round((vkladVolumeFact / vkladVolumePlan) * 100) : (vkladVolumeFact > 0 ? 100 : 0);

    const dkVolumeFact = validateInput(document.getElementById('dk_volume_fact').value, 0, 100000000);
    const dkVolumePercent = dkVolumePlan > 0 ? Math.round((dkVolumeFact / dkVolumePlan) * 100) : (dkVolumeFact > 0 ? 100 : 0);

    const kvcFact = validateInput(document.getElementById('kvc_fact').value, 0, 1000);
    const kvcPercent = kvcPlan > 0 ? Math.round((kvcFact / kvcPlan) * 100) : (kvcFact > 0 ? 100 : 0);

    const krhStrata = getStrataByPercent(krhPercent);
    const vkladStrata = getStrataByPercent(vkladVolumePercent);
    const dkStrata = getStrataByPercent(dkVolumePercent);
    const kvcStrata = getStrataByPercent(kvcPercent);

    document.getElementById('plan_results').innerHTML = `
      –ö–†–•: ${krhFact}/${krhPlan} = ${krhPercent}% <span class="strata-badge">–°—Ç—Ä–∞—Ç–∞ ${krhStrata.strata}</span> <span class="multiplier-badge">√ó${krhStrata.multiplier}</span> <span class="points-badge">${krhStrata.points} –±–∞–ª–ª–æ–≤</span><br>
      –í–∫–ª–∞–¥ –æ–±—ä–µ–º: ${vkladVolumeFact.toLocaleString()}/${vkladVolumePlan.toLocaleString()} = ${vkladVolumePercent}% <span class="strata-badge">–°—Ç—Ä–∞—Ç–∞ ${vkladStrata.strata}</span> <span class="multiplier-badge">√ó${vkladStrata.multiplier}</span> <span class="points-badge">${vkladStrata.points} –±–∞–ª–ª–æ–≤</span><br>
      –î–ö –æ–±—ä–µ–º: ${dkVolumeFact.toLocaleString()}/${dkVolumePlan.toLocaleString()} = ${dkVolumePercent}% <span class="strata-badge">–°—Ç—Ä–∞—Ç–∞ ${dkStrata.strata}</span> <span class="multiplier-badge">√ó${dkStrata.multiplier}</span> <span class="points-badge">${dkStrata.points} –±–∞–ª–ª–æ–≤</span><br>
      –ö–í–¶: ${kvcFact}/${kvcPlan} = ${kvcPercent}% <span class="strata-badge">–°—Ç—Ä–∞—Ç–∞ ${kvcStrata.strata}</span> <span class="multiplier-badge">√ó${kvcStrata.multiplier}</span> <span class="points-badge">${kvcStrata.points} –±–∞–ª–ª–æ–≤</span>
    `;

    let dkSum = 0;
    let eligibleCreditsCount = 0;
    const creditPremiumInputs = document.querySelectorAll('input[id^="credit-premium-"]');
    creditPremiumInputs.forEach(premiumInput => {
      const creditPremiumText = premiumInput.value;
      const creditPremium = parseInt(creditPremiumText.replace(/\s/g, '').replace('‚ÇΩ', '')) || 0;
      
      if (dkVolumePercent >= 70) {
        dkSum += creditPremium;
      } else {
        const creditRow = premiumInput.closest('.credit-row');
        const typeSelect = creditRow.querySelector('.credit-type');
        if (typeSelect) {
          const creditType = typeSelect.value;
          const creditConfig = CREDIT_TYPES[creditType];
          dkSum += creditConfig.base;
        }
      }
      
      if (creditPremium > 0) {
        eligibleCreditsCount++;
      }
    });
    
    const dkSumAfterMultiplier = dkSum * dkStrata.multiplier;

    const vkladCountFact = validateInput(document.getElementById('vklad_count_fact').value, 0, 1000);
    const vkladySum = vkladCountFact * 200;
    const vkladySumAfterMultiplier = vkladySum * vkladStrata.multiplier;

    const startedKrhSum = krhFact * 600;
    const startedKrhSumAfterMultiplier = startedKrhSum * krhStrata.multiplier;

    const mainProductsSum = dkSumAfterMultiplier + vkladySumAfterMultiplier + startedKrhSumAfterMultiplier;

    let otherProductsSum = 0;
    const stickerCount = validateInput(document.getElementById('sticker_count').value, 0, 1000);
    const stickerSum = stickerCount * 50;

    const yearSubCount = validateInput(document.getElementById('year_sub_count').value, 0, 1000);
    const yearSubSum = yearSubCount * 500;

    const monthSubCount = validateInput(document.getElementById('month_sub_count').value, 0, 1000);
    const monthSubSum = monthSubCount * 200;

    const krhLimitCount = validateInput(document.getElementById('krh_limit_count').value, 0, 1000);
    const krhLimitSum = krhLimitCount * 100;

    const zpCardCount = validateInput(document.getElementById('zp_card_count').value, 0, 1000);
    const zpCardSum = zpCardCount * 100;

    const ompCount = validateInput(document.getElementById('omp_count').value, 0, 1000);
    const ompSum = ompCount * 50;

    const zpNerezCount = validateInput(document.getElementById('zp_nerez_count').value, 0, 1000);
    const zpNerezSum = zpNerezCount * 300;

    const cardTurnover = validateInput(document.getElementById('card_turnover').value, 0, 100000000);
    const cardTurnoverSum = Math.min(cardTurnover * 0.03, 100000);

    const skbCount = validateInput(document.getElementById('skb_count').value, 0, 1000);
    const crmCalls = validateInput(document.getElementById('crm_calls').value, 0, 1000);

    otherProductsSum = stickerSum + yearSubSum + monthSubSum + krhLimitSum + zpCardSum + ompSum + zpNerezSum + cardTurnoverSum;

    document.getElementById('payments_results').innerHTML = `
      –ö—Ä–µ–¥–∏—Ç—ã: ${dkSum.toLocaleString()}‚ÇΩ √ó ${dkStrata.multiplier} = ${dkSumAfterMultiplier.toLocaleString()}‚ÇΩ<br>
      –í–∫–ª–∞–¥—ã: ${vkladySum.toLocaleString()}‚ÇΩ √ó ${vkladStrata.multiplier} = ${vkladySumAfterMultiplier.toLocaleString()}‚ÇΩ<br>
      –ö–†–•: ${startedKrhSum.toLocaleString()}‚ÇΩ √ó ${krhStrata.multiplier} = ${startedKrhSumAfterMultiplier.toLocaleString()}‚ÇΩ<br>
      –î–æ–ø. –ø—Ä–æ–¥—É–∫—Ç—ã: ${otherProductsSum.toLocaleString()}‚ÇΩ
    `;

    let skbPoints = 0;
    let crmPoints = 0;
    skbPoints = skbCount < 3 ? 1 : -1;
    if (crmCalls <= 50) {
      crmPoints = 2;
    } else if (crmCalls > 50 && crmCalls < 60) {
      crmPoints = 0;
    } else {
      crmPoints = -2;
    }

    document.getElementById('championship_results').innerHTML = `
      –°–ö–ë: ${skbCount} —à—Ç. ‚Üí ${skbPoints > 0 ? '+' : ''}${skbPoints} –±–∞–ª–ª<br>
      –î–æ–∑–≤–æ–Ω—ã: ${crmCalls} ‚Üí ${crmPoints > 0 ? '+' : ''}${crmPoints} –±–∞–ª–ª–æ–≤<br>
      –ò—Ç–æ–≥–æ –ß–ü: ${skbPoints + crmPoints} –±–∞–ª–ª–æ–≤
    `;

    const totalPoints = krhStrata.points + vkladStrata.points + dkStrata.points + kvcStrata.points;
    const championshipPoints = skbPoints + crmPoints;
    const finalPoints = totalPoints + championshipPoints;
    const finalStrata = getFinalStrata(finalPoints);

    document.getElementById('final_strata_calculation').innerHTML = `
      –°—É–º–º–∞ –±–∞–ª–ª–æ–≤ –ø–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º: ${krhStrata.points} + ${vkladStrata.points} + ${dkStrata.points} + ${kvcStrata.points} = ${totalPoints} –±–∞–ª–ª–æ–≤<br>
      –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ß–ü: ${championshipPoints} –±–∞–ª–ª–æ–≤<br>
      –ò—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã: ${totalPoints} + ${championshipPoints} = ${finalPoints} –±–∞–ª–ª–æ–≤<br>
      <strong>–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–∞: <span class="final-strata-badge">${finalStrata}</span></strong>
    `;

    const positionBonus = parseInt(document.getElementById('position').value) || 0;
    const moscowCoef = parseFloat(document.getElementById('moscow_coef').value) || 1;

    const extraBonus = eligibleCreditsCount >= 3 ? 5000 : 0;

    const sumBeforeMoscow = mainProductsSum + otherProductsSum;
    const sumAfterMoscow = sumBeforeMoscow * moscowCoef;
    const finalPremium = sumAfterMoscow + extraBonus + positionBonus;

    let detailedHTML = '';
    detailedHTML = `
      <div class="detail-item">
        <span class="detail-label">–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã:</span>
        <span class="detail-value">${mainProductsSum.toLocaleString()}‚ÇΩ</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">–î–æ–ø. –ø—Ä–æ–¥—É–∫—Ç—ã:</span>
        <span class="detail-value">${otherProductsSum.toLocaleString()}‚ÇΩ</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">–°—É–º–º–∞ –¥–æ —Ä–µ–≥–∏–æ–Ω. –∫–æ—ç—Ñ.:</span>
        <span class="detail-value">${sumBeforeMoscow.toLocaleString()}‚ÇΩ</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">–†–µ–≥–∏–æ–Ω. –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (${moscowCoef}):</span>
        <span class="detail-value">${sumAfterMoscow.toLocaleString()}‚ÇΩ</span>
      </div>
    `;
    
    if (extraBonus > 0) {
      detailedHTML += `
        <div class="detail-item">
          <span class="detail-label">–≠–∫—Å—Ç—Ä–∞–±–æ–Ω—É—Å –∑–∞ 3+ –∫—Ä–µ–¥–∏—Ç–∞:</span>
          <span class="detail-value">+${extraBonus.toLocaleString()}‚ÇΩ</span>
        </div>
      `;
    }
    
    detailedHTML += `
      <div class="detail-item">
        <span class="detail-label">–ù–∞–¥–±–∞–≤–∫–∞ –∑–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—å:</span>
        <span class="detail-value">+${positionBonus.toLocaleString()}‚ÇΩ</span>
      </div>
    `;
    
    document.getElementById('detailed_calculation').innerHTML = detailedHTML;

    document.getElementById('final_premium').textContent = Math.round(finalPremium).toLocaleString() + ' ‚ÇΩ';
    document.getElementById('results').style.display = 'block';
    
    const chartData = [
      { label: '–ö—Ä–µ–¥–∏—Ç—ã', value: dkSumAfterMultiplier, color: CHART_COLORS[0] },
      { label: '–í–∫–ª–∞–¥—ã', value: vkladySumAfterMultiplier, color: CHART_COLORS[1] },
      { label: '–ö–†–•', value: startedKrhSumAfterMultiplier, color: CHART_COLORS[2] },
      { label: '–î–æ–ø. –ø—Ä–æ–¥—É–∫—Ç—ã', value: otherProductsSum, color: CHART_COLORS[3] }
    ];
    
    if (extraBonus > 0) {
      chartData.push({ label: '–≠–∫—Å—Ç—Ä–∞–±–æ–Ω—É—Å', value: extraBonus, color: CHART_COLORS[4] });
    }
    
    if (positionBonus > 0) {
      chartData.push({ label: '–ù–∞–¥–±–∞–≤–∫–∞ –∑–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—å', value: positionBonus, color: CHART_COLORS[5] });
    }
    
    const filteredData = chartData.filter(item => item.value > 0);
    drawPremiumPieChart(filteredData);
    updateChartLegend(filteredData);
    
    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    
    hideLoader();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–µ–º–∏–∏:', error);
    hideLoader();
    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –ø—Ä–µ–º–∏–∏: ' + error.message);
  }
}

// üîß –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–¢–ß–ï–¢–û–í (–ú–ü–ü)

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
async function saveWeeklyReport() {
  if (!selectedWeek) {
    showError('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–µ–ª—é –¥–ª—è –æ—Ç—á–µ—Ç–∞');
    return;
  }

  try {
    showLoader("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...");
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—è—Ü, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –Ω–µ–¥–µ–ª—è
    const weekMonth = new Date(selectedWeek.start);
    const monthKey = `${weekMonth.getFullYear()}-${(weekMonth.getMonth() + 1).toString().padStart(2, '0')}`;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞
    const plans = await getPlansForMonth(monthKey);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
    const kvc = validateInput(document.getElementById('report-kvc').value, 0, 1000);
    const krh = validateInput(document.getElementById('report-krh').value, 0, 1000);
    const dkVolume = validateInput(document.getElementById('report-dk-volume').value, 0, 100000000);
    const vkladVolume = validateInput(document.getElementById('report-vklad-volume').value, 0, 100000000);
    const dkCount = validateInput(document.getElementById('report-dk-count').value, 0, 1000);
    const vkladCount = validateInput(document.getElementById('report-vklad-count').value, 0, 1000);
    
    const stickerCount = validateInput(document.getElementById('report-sticker-count').value, 0, 1000);
    const yearSubCount = validateInput(document.getElementById('report-year-sub-count').value, 0, 1000);
    const monthSubCount = validateInput(document.getElementById('report-month-sub-count').value, 0, 1000);
    const krhLimitCount = validateInput(document.getElementById('report-krh-limit-count').value, 0, 1000);
    const zpCardCount = validateInput(document.getElementById('report-zp-card-count').value, 0, 1000);
    const ompCount = validateInput(document.getElementById('report-omp-count').value, 0, 1000);
    const zpNerezCount = validateInput(document.getElementById('report-zp-nerez-count').value, 0, 1000);
    const cardTurnover = validateInput(document.getElementById('report-card-turnover').value, 0, 100000000);
    
    const skbCount = validateInput(document.getElementById('report-skb-count').value, 0, 1000);
    const crmCalls = validateInput(document.getElementById('report-crm-calls').value, 0, 1000);

    const credits = [];
    reportCreditIds.forEach(id => {
      const typeSelect = document.getElementById(`report-credit-type-${id}`);
      const packageSelect = document.getElementById(`report-credit-package-${id}`);
      const fzSelect = document.getElementById(`report-credit-fz-${id}`);
      const amountInput = document.getElementById(`report-credit-amount-${id}`);
      const premiumInput = document.getElementById(`report-credit-premium-${id}`);

      if (typeSelect && packageSelect && fzSelect && amountInput && premiumInput) {
        const creditType = typeSelect.value;
        const packageValue = packageSelect.value;
        const hasFZ = fzSelect.value === 'true';
        const creditAmount = parseInt(amountInput.value) || 0;
        const creditPremium = parseInt(premiumInput.value.replace(/\s/g, '').replace('‚ÇΩ', '')) || 0;
        
        credits.push({
          type: creditType,
          package: packageValue,
          fz: hasFZ,
          amount: creditAmount,
          premium: creditPremium
        });
      }
    });

    if (currentUser && currentUser.id !== 'demo' && firebaseInitialized) {
      const existingReportQuery = await db.collection('weeklyReports')
        .where('userId', '==', String(currentUser.id))
        .where('weekStart', '==', firebase.firestore.Timestamp.fromDate(selectedWeek.start))
        .get();

      if (!existingReportQuery.empty) {
        hideLoader();
        showError('–û—Ç—á–µ—Ç –∑–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        return;
      }

      await db.collection('weeklyReports').add({
        userId: String(currentUser.id),
        weekStart: firebase.firestore.Timestamp.fromDate(selectedWeek.start),
        weekEnd: firebase.firestore.Timestamp.fromDate(selectedWeek.end),
        startDate: formatDate(selectedWeek.start),
        endDate: formatDate(selectedWeek.end),
        monthKey: monthKey,
        plans: plans, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞
        kvc: kvc,
        krh: krh,
        dkVolume: dkVolume,
        vkladVolume: vkladVolume,
        dkCount: dkCount,
        vkladCount: vkladCount,
        credits: credits,
        stickerCount: stickerCount,
        yearSubCount: yearSubCount,
        monthSubCount: monthSubCount,
        krhLimitCount: krhLimitCount,
        zpCardCount: zpCardCount,
        ompCount: ompCount,
        zpNerezCount: zpNerezCount,
        cardTurnover: cardTurnover,
        skbCount: skbCount,
        crmCalls: crmCalls,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      hideLoader();
      showSuccess('–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
      
      // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
      document.getElementById('report-kvc').value = '0';
      document.getElementById('report-krh').value = '0';
      document.getElementById('report-dk-volume').value = '0';
      document.getElementById('report-vklad-volume').value = '0';
      document.getElementById('report-dk-count').value = '0';
      document.getElementById('report-vklad-count').value = '0';
      document.getElementById('report-sticker-count').value = '0';
      document.getElementById('report-year-sub-count').value = '0';
      document.getElementById('report-month-sub-count').value = '0';
      document.getElementById('report-krh-limit-count').value = '0';
      document.getElementById('report-zp-card-count').value = '0';
      document.getElementById('report-omp-count').value = '0';
      document.getElementById('report-zp-nerez-count').value = '0';
      document.getElementById('report-card-turnover').value = '0';
      document.getElementById('report-skb-count').value = '0';
      document.getElementById('report-crm-calls').value = '0';
      
      reportCreditIds.forEach(id => {
        const creditRow = document.getElementById(`report-credit-${id}`);
        if (creditRow) creditRow.remove();
      });
      reportCreditIds = [];
    } else {
      hideLoader();
      showError('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –≤—ã –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞:', error);
    hideLoader();
    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞: ' + error.message);
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
async function saveMonthlyReport() {
  const monthSelect = document.getElementById('month-select');
  const selectedMonth = monthSelect.value;
  
  if (!selectedMonth) {
    showError('–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü –¥–ª—è –æ—Ç—á–µ—Ç–∞');
    return;
  }

  try {
    showLoader("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...");
    
    const [year, month] = selectedMonth.split('-').map(Number);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞–Ω—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
    const plans = await getPlansForMonth(selectedMonth);

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
    const kvc = validateInput(document.getElementById('monthly-report-kvc').value, 0, 1000);
    const krh = validateInput(document.getElementById('monthly-report-krh').value, 0, 1000);
    const dkVolume = validateInput(document.getElementById('monthly-report-dk-volume').value, 0, 100000000);
    const vkladVolume = validateInput(document.getElementById('monthly-report-vklad-volume').value, 0, 100000000);
    const dkCount = validateInput(document.getElementById('monthly-report-dk-count').value, 0, 1000);
    const vkladCount = validateInput(document.getElementById('monthly-report-vklad-count').value, 0, 1000);
    
    const stickerCount = validateInput(document.getElementById('monthly-report-sticker-count').value, 0, 1000);
    const yearSubCount = validateInput(document.getElementById('monthly-report-year-sub-count').value, 0, 1000);
    const monthSubCount = validateInput(document.getElementById('monthly-report-month-sub-count').value, 0, 1000);
    const krhLimitCount = validateInput(document.getElementById('monthly-report-krh-limit-count').value, 0, 1000);
    const zpCardCount = validateInput(document.getElementById('monthly-report-zp-card-count').value, 0, 1000);
    const ompCount = validateInput(document.getElementById('monthly-report-omp-count').value, 0, 1000);
    const zpNerezCount = validateInput(document.getElementById('monthly-report-zp-nerez-count').value, 0, 1000);
    const cardTurnover = validateInput(document.getElementById('monthly-report-card-turnover').value, 0, 100000000);
    
    const skbCount = validateInput(document.getElementById('monthly-report-skb-count').value, 0, 1000);
    const crmCalls = validateInput(document.getElementById('monthly-report-crm-calls').value, 0, 1000);

    const credits = [];
    monthlyReportCreditIds.forEach(id => {
      const typeSelect = document.getElementById(`monthly-report-credit-type-${id}`);
      const packageSelect = document.getElementById(`monthly-report-credit-package-${id}`);
      const fzSelect = document.getElementById(`monthly-report-credit-fz-${id}`);
      const amountInput = document.getElementById(`monthly-report-credit-amount-${id}`);
      const premiumInput = document.getElementById(`monthly-report-credit-premium-${id}`);

      if (typeSelect && packageSelect && fzSelect && amountInput && premiumInput) {
        const creditType = typeSelect.value;
        const packageValue = packageSelect.value;
        const hasFZ = fzSelect.value === 'true';
        const creditAmount = parseInt(amountInput.value) || 0;
        const creditPremium = parseInt(premiumInput.value.replace(/\s/g, '').replace('‚ÇΩ', '')) || 0;
        
        credits.push({
          type: creditType,
          package: packageValue,
          fz: hasFZ,
          amount: creditAmount,
          premium: creditPremium
        });
      }
    });

    // –†–∞—Å—á–µ—Ç–Ω–∞—è –ø—Ä–µ–º–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–ª–∞–Ω–æ–≤ –∏–∑ –±–∞–∑—ã
    const calculatedPremium = calculateTotalPremiumWithPlans({
      krh: krh,
      vkladCount: vkladCount,
      credits: credits,
      ompCount: ompCount,
      zpNerezCount: zpNerezCount,
      stickerCount: stickerCount,
      yearSubCount: yearSubCount,
      monthSubCount: monthSubCount,
      krhLimitCount: krhLimitCount,
      zpCardCount: zpCardCount,
      cardTurnover: cardTurnover,
      dkVolume: dkVolume,
      vkladVolume: vkladVolume,
      kvc: kvc
    }, plans);

    // –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–µ–º–∏—è (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)
    const adjustedPremium = validateInput(document.getElementById('monthly-adjusted-premium').value, 0, 1000000) || calculatedPremium;

    if (currentUser && currentUser.id !== 'demo' && firebaseInitialized) {
      const existingReportQuery = await db.collection('monthlyReports')
        .where('userId', '==', String(currentUser.id))
        .where('monthKey', '==', selectedMonth)
        .get();

      if (!existingReportQuery.empty) {
        // –ï—Å–ª–∏ –æ—Ç—á–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
        const existingReportDoc = existingReportQuery.docs[0];
        await db.collection('monthlyReports').doc(existingReportDoc.id).update({
          kvc: kvc,
          krh: krh,
          dkVolume: dkVolume,
          vkladVolume: vkladVolume,
          dkCount: dkCount,
          vkladCount: vkladCount,
          credits: credits,
          stickerCount: stickerCount,
          yearSubCount: yearSubCount,
          monthSubCount: monthSubCount,
          krhLimitCount: krhLimitCount,
          zpCardCount: zpCardCount,
          ompCount: ompCount,
          zpNerezCount: zpNerezCount,
          cardTurnover: cardTurnover,
          skbCount: skbCount,
          crmCalls: crmCalls,
          plans: plans, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ
          calculatedPremium: calculatedPremium,
          adjustedPremium: adjustedPremium,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        hideLoader();
        showSuccess('–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!');
      } else {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ—Ç—á–µ—Ç
        await db.collection('monthlyReports').add({
          userId: String(currentUser.id),
          monthKey: selectedMonth,
          year: year,
          month: month,
          monthName: `${MONTHS_GENITIVE[month-1]} ${year}`,
          kvc: kvc,
          krh: krh,
          dkVolume: dkVolume,
          vkladVolume: vkladVolume,
          dkCount: dkCount,
          vkladCount: vkladCount,
          credits: credits,
          stickerCount: stickerCount,
          yearSubCount: yearSubCount,
          monthSubCount: monthSubCount,
          krhLimitCount: krhLimitCount,
          zpCardCount: zpCardCount,
          ompCount: ompCount,
          zpNerezCount: zpNerezCount,
          cardTurnover: cardTurnover,
          skbCount: skbCount,
          crmCalls: crmCalls,
          plans: plans, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ
          calculatedPremium: calculatedPremium,
          adjustedPremium: adjustedPremium,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        hideLoader();
        showSuccess('–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
      }
      
      // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
      document.getElementById('monthly-report-kvc').value = '0';
      document.getElementById('monthly-report-krh').value = '0';
      document.getElementById('monthly-report-dk-volume').value = '0';
      document.getElementById('monthly-report-vklad-volume').value = '0';
      document.getElementById('monthly-report-dk-count').value = '0';
      document.getElementById('monthly-report-vklad-count').value = '0';
      document.getElementById('monthly-report-sticker-count').value = '0';
      document.getElementById('monthly-report-year-sub-count').value = '0';
      document.getElementById('monthly-report-month-sub-count').value = '0';
      document.getElementById('monthly-report-krh-limit-count').value = '0';
      document.getElementById('monthly-report-zp-card-count').value = '0';
      document.getElementById('monthly-report-omp-count').value = '0';
      document.getElementById('monthly-report-zp-nerez-count').value = '0';
      document.getElementById('monthly-report-card-turnover').value = '0';
      document.getElementById('monthly-report-skb-count').value = '0';
      document.getElementById('monthly-report-crm-calls').value = '0';
      document.getElementById('monthly-adjusted-premium').value = '0';
      
      monthlyReportCreditIds.forEach(id => {
        const creditRow = document.getElementById(`monthly-report-credit-${id}`);
        if (creditRow) creditRow.remove();
      });
      monthlyReportCreditIds = [];
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
      await loadProfile();
    } else {
      hideLoader();
      showError('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –≤—ã –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –µ–∂–µ–º–µ—Å—è—á–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞:', error);
    hideLoader();
    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞: ' + error.message);
  }
}

// –†–∞—Å—á–µ—Ç –ø—Ä–µ–º–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–ª–∞–Ω–æ–≤
function calculateTotalPremiumWithPlans(stats, plans) {
  // –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
  const krhPercent = plans.krh_plan > 0 ? Math.round((stats.krh / plans.krh_plan) * 100) : (stats.krh > 0 ? 100 : 0);
  const vkladVolumePercent = plans.vklad_volume_plan > 0 ? Math.round((stats.vkladVolume / plans.vklad_volume_plan) * 100) : (stats.vkladVolume > 0 ? 100 : 0);
  const dkVolumePercent = plans.dk_volume_plan > 0 ? Math.round((stats.dkVolume / plans.dk_volume_plan) * 100) : (stats.dkVolume > 0 ? 100 : 0);
  const kvcPercent = plans.kvc_plan > 0 ? Math.round((stats.kvc / plans.kvc_plan) * 100) : (stats.kvc > 0 ? 100 : 0);

  // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–∞—Ç—ã
  const krhStrata = getStrataByPercent(krhPercent);
  const vkladStrata = getStrataByPercent(vkladVolumePercent);
  const dkStrata = getStrataByPercent(dkVolumePercent);
  const kvcStrata = getStrataByPercent(kvcPercent);

  // –†–∞—Å—á–µ—Ç –ø—Ä–µ–º–∏–∏ –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º
  const creditsPremium = stats.credits.reduce((sum, credit) => sum + (credit.premium || 0), 0);
  const dkSumAfterMultiplier = creditsPremium * dkStrata.multiplier;

  // –†–∞—Å—á–µ—Ç –ø—Ä–µ–º–∏–∏ –ø–æ –≤–∫–ª–∞–¥–∞–º
  const vkladySum = stats.vkladCount * 200;
  const vkladySumAfterMultiplier = vkladySum * vkladStrata.multiplier;

  // –†–∞—Å—á–µ—Ç –ø—Ä–µ–º–∏–∏ –ø–æ –ö–†–•
  const startedKrhSum = stats.krh * 600;
  const startedKrhSumAfterMultiplier = startedKrhSum * krhStrata.multiplier;

  // –†–∞—Å—á–µ—Ç –ø—Ä–µ–º–∏–∏ –ø–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ø—Ä–æ–¥—É–∫—Ç–∞–º
  const additionalPremium =
    (stats.ompCount * 50) +
    (stats.zpNerezCount * 300) +
    (stats.stickerCount * 50) +
    (stats.yearSubCount * 500) +
    (stats.monthSubCount * 200) +
    (stats.krhLimitCount * 100) +
    (stats.zpCardCount * 100) +
    Math.min(stats.cardTurnover * 0.03, 100000);

  // –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–µ–º–∏—è
  return dkSumAfterMultiplier + vkladySumAfterMultiplier + startedKrhSumAfterMultiplier + additionalPremium;
}

// üîß –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–û–ü–ê –°–û–¢–†–£–î–ù–ò–ö–û–í

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ø–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
async function loadLeaderboard(period = 'week') {
  if (!firebaseInitialized) {
    showDemoLeaderboard(period);
    return;
  }

  try {
    showLoader("–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ø–∞...");
    
    let startDate, endDate;
    const now = new Date();
    
    if (period === 'week') {
      const dayOfWeek = now.getDay();
      const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      startDate = new Date(now);
      startDate.setDate(now.getDate() + diffToMonday);
      startDate.setHours(0, 0, 0, 0);
      endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + 6);
      endDate.setHours(23, 59, 59, 999);
      
      document.getElementById('current-period-leaderboard').style.display = 'block';
      document.getElementById('last-month-leaderboard').style.display = 'none';
      document.getElementById('records-leaderboard').style.display = 'none';
    } else if (period === 'month') {
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      endDate.setHours(23, 59, 59, 999);
      
      document.getElementById('current-period-leaderboard').style.display = 'block';
      document.getElementById('last-month-leaderboard').style.display = 'none';
      document.getElementById('records-leaderboard').style.display = 'none';
    } else if (period === 'last-month') {
      await loadLastMonthLeaderboard();
      hideLoader();
      return;
    } else if (period === 'records') {
      await loadSalesRecords();
      hideLoader();
      return;
    }

    const usersSnapshot = await db.collection('users')
      .where('role', '==', 'mpp')
      .get();

    if (usersSnapshot.empty) {
      hideLoader();
      showDemoLeaderboard(period);
      return;
    }

    const leaderboardData = [];

    for (const userDoc of usersSnapshot.docs) {
      const user = userDoc.data();
      try {
        const reportsQuery = await db.collection('weeklyReports')
          .where('userId', '==', String(userDoc.id))
          .where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(startDate))
          .where('createdAt', '<=', firebase.firestore.Timestamp.fromDate(endDate))
          .get();
        
        let totalStats = {
          kvc: 0,
          dkVolume: 0,
          dkCount: 0,
          vkladVolume: 0,
          vkladCount: 0,
          krh: 0,
          credits: [],
          ompCount: 0,
          zpNerezCount: 0,
          stickerCount: 0,
          yearSubCount: 0,
          monthSubCount: 0,
          krhLimitCount: 0,
          zpCardCount: 0,
          cardTurnover: 0
        };
        
        reportsQuery.forEach(doc => {
          const report = doc.data();
          totalStats.kvc += report.kvc || 0;
          totalStats.dkVolume += report.dkVolume || 0;
          totalStats.dkCount += report.dkCount || 0;
          totalStats.vkladVolume += report.vkladVolume || 0;
          totalStats.vkladCount += report.vkladCount || 0;
          totalStats.krh += report.krh || 0;
          totalStats.ompCount += report.ompCount || 0;
          totalStats.zpNerezCount += report.zpNerezCount || 0;
          totalStats.stickerCount += report.stickerCount || 0;
          totalStats.yearSubCount += report.yearSubCount || 0;
          totalStats.monthSubCount += report.monthSubCount || 0;
          totalStats.krhLimitCount += report.krhLimitCount || 0;
          totalStats.zpCardCount += report.zpCardCount || 0;
          totalStats.cardTurnover += report.cardTurnover || 0;
          
          if (report.credits) {
            totalStats.credits = totalStats.credits.concat(report.credits);
          }
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞–Ω—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–µ–º–∏–∏
        const monthKey = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
        const plans = await getPlansForMonth(monthKey);

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–µ–º–∏—é —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–ª–∞–Ω–æ–≤
        const premium = calculateTotalPremiumWithPlans(totalStats, plans);

        leaderboardData.push({
          user: user,
          stats: totalStats,
          premium: premium,
          userId: userDoc.id
        });
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userDoc.id}:`, error);
      }
    }

    updatePremiumLeaderboard(leaderboardData);
    updateCreditsLeaderboard(leaderboardData);
    updateDepositsLeaderboard(leaderboardData);
    hideLoader();

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ø–∞:', error);
    hideLoader();
    showDemoLeaderboard(period);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ø–∞ –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
async function loadLastMonthLeaderboard() {
  try {
    showLoader("–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ø–∞ –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü...");
    
    const now = new Date();
    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const monthKey = `${lastMonth.getFullYear()}-${(lastMonth.getMonth() + 1).toString().padStart(2, '0')}`;
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ú–ü–ü
    const usersSnapshot = await db.collection('users')
      .where('role', '==', 'mpp')
      .get();

    if (usersSnapshot.empty) {
      document.getElementById('last-month-premium-leaderboard').innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</p>';
      hideLoader();
      return;
    }

    const leaderboardData = [];
    
    // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–∞–µ–º –æ—Ç—á–µ—Ç –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
    for (const userDoc of usersSnapshot.docs) {
      const user = userDoc.data();
      
      try {
        const monthlyReportQuery = await db.collection('monthlyReports')
          .where('userId', '==', userDoc.id)
          .where('monthKey', '==', monthKey)
          .get();

        let premium = 0;

        if (!monthlyReportQuery.empty) {
          const report = monthlyReportQuery.docs[0].data();
          premium = report.adjustedPremium || report.calculatedPremium || 0;
        }

        leaderboardData.push({
          user: user,
          userId: userDoc.id,
          premium: premium
        });
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userDoc.id}:`, error);
      }
    }
    
    document.getElementById('current-period-leaderboard').style.display = 'none';
    document.getElementById('last-month-leaderboard').style.display = 'block';
    document.getElementById('records-leaderboard').style.display = 'none';
    
    updateLastMonthPremiumLeaderboard(leaderboardData);
    hideLoader();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ø–∞ –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü:', error);
    hideLoader();
    document.getElementById('last-month-premium-leaderboard').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ø–∞ –ø–æ –ø—Ä–µ–º–∏–∏
function updatePremiumLeaderboard(leaderboardData) {
  const premiumSorted = [...leaderboardData].sort((a, b) => {
    return (b.premium || 0) - (a.premium || 0);
  });
  
  const premiumLeaderboard = document.getElementById('premium-leaderboard');
  if (premiumSorted.length === 0) {
    premiumLeaderboard.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
    return;
  }
  
  premiumLeaderboard.innerHTML = premiumSorted.slice(0, 10).map((item, index) => {
    const premium = item.premium || 0;
    const displayName = `${item.user.firstName || ''} ${item.user.lastName || ''}`.trim() || '–ê–Ω–æ–Ω–∏–º';
    return `
      <div class="leaderboard-item">
        <span class="rank">${index + 1}</span>
        <span class="name">${displayName}</span>
        <span class="value">${Math.round(premium).toLocaleString()} ‚ÇΩ</span>
      </div>
    `;
  }).join('');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ø–∞ –ø–æ –ø—Ä–µ–º–∏–∏ –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
function updateLastMonthPremiumLeaderboard(leaderboardData) {
  const premiumSorted = [...leaderboardData].sort((a, b) => {
    return (b.premium || 0) - (a.premium || 0);
  });
  
  const premiumLeaderboard = document.getElementById('last-month-premium-leaderboard');
  if (premiumSorted.length === 0) {
    premiumLeaderboard.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
    return;
  }
  
  premiumLeaderboard.innerHTML = premiumSorted.slice(0, 10).map((item, index) => {
    const premium = item.premium || 0;
    const displayName = `${item.user.firstName || ''} ${item.user.lastName || ''}`.trim() || '–ê–Ω–æ–Ω–∏–º';
    return `
      <div class="leaderboard-item">
        <span class="rank">${index + 1}</span>
        <span class="name">${displayName}</span>
        <span class="value">${Math.round(premium).toLocaleString()} ‚ÇΩ</span>
      </div>
    `;
  }).join('');
}

// –†–∞—Å—á–µ—Ç –æ–±—â–µ–π –ø—Ä–µ–º–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
function calculateTotalPremium(stats) {
  const creditsPremium = stats.credits.reduce((sum, credit) => sum + (credit.premium || 0), 0);
  const additionalPremium =
    (stats.ompCount * 50) +
    (stats.zpNerezCount * 300) +
    (stats.stickerCount * 50) +
    (stats.yearSubCount * 500) +
    (stats.monthSubCount * 200) +
    (stats.krhLimitCount * 100) +
    (stats.zpCardCount * 100) +
    Math.min(stats.cardTurnover * 0.03, 100000);
    
  return (stats.krh * 600) +
    (stats.vkladCount * 200) +
    creditsPremium +
    additionalPremium;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ø–∞ –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º
function updateCreditsLeaderboard(leaderboardData) {
  const creditsSorted = [...leaderboardData].sort((a, b) =>
    (b.stats.dkCount || 0) - (a.stats.dkCount || 0)
  );
  
  const creditsLeaderboard = document.getElementById('credits-leaderboard');
  if (creditsSorted.length === 0) {
    creditsLeaderboard.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
    return;
  }
  
  creditsLeaderboard.innerHTML = creditsSorted.slice(0, 10).map((item, index) => {
    const displayName = `${item.user.firstName || ''} ${item.user.lastName || ''}`.trim() || '–ê–Ω–æ–Ω–∏–º';
    return `
      <div class="leaderboard-item">
        <span class="rank">${index + 1}</span>
        <span class="name">${displayName}</span>
        <span class="value">${item.stats.dkCount || 0} —à—Ç.</span>
      </div>
    `;
  }).join('');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ø–∞ –ø–æ –≤–∫–ª–∞–¥–∞–º
function updateDepositsLeaderboard(leaderboardData) {
  const depositsSorted = [...leaderboardData].sort((a, b) =>
    (b.stats.vkladCount || 0) - (a.stats.vkladCount || 0)
  );
  
  const depositsLeaderboard = document.getElementById('deposits-leaderboard');
  if (depositsSorted.length === 0) {
    depositsLeaderboard.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
    return;
  }
  
  depositsLeaderboard.innerHTML = depositsSorted.slice(0, 10).map((item, index) => {
    const displayName = `${item.user.firstName || ''} ${item.user.lastName || ''}`.trim() || '–ê–Ω–æ–Ω–∏–º';
    return `
      <div class="leaderboard-item">
        <span class="rank">${index + 1}</span>
        <span class="name">${displayName}</span>
        <span class="value">${item.stats.vkladCount || 0} —à—Ç.</span>
      </div>
    `;
  }).join('');
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–æ–ø–∞
function showDemoLeaderboard(period) {
  const premiumLeaderboard = document.getElementById('premium-leaderboard');
  const creditsLeaderboard = document.getElementById('credits-leaderboard');
  const depositsLeaderboard = document.getElementById('deposits-leaderboard');
  
  if (period === 'last-month') {
    document.getElementById('last-month-premium-leaderboard').innerHTML = `
      <div class="leaderboard-item">
        <span class="rank">1</span>
        <span class="name">–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω</span>
        <span class="value">45,000 ‚ÇΩ</span>
      </div>
      <div class="leaderboard-item">
        <span class="rank">2</span>
        <span class="name">–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä</span>
        <span class="value">42,500 ‚ÇΩ</span>
      </div>
      <div class="leaderboard-item">
        <span class="rank">3</span>
        <span class="name">–°–∏–¥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–µ–π</span>
        <span class="value">40,000 ‚ÇΩ</span>
      </div>
    `;
    
    document.getElementById('current-period-leaderboard').style.display = 'none';
    document.getElementById('last-month-leaderboard').style.display = 'block';
    document.getElementById('records-leaderboard').style.display = 'none';
  } else if (period === 'records') {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∫–æ—Ä–¥–æ–≤
    document.getElementById('current-period-leaderboard').style.display = 'none';
    document.getElementById('last-month-leaderboard').style.display = 'none';
    document.getElementById('records-leaderboard').style.display = 'block';
    
    document.getElementById('credits-record-value').textContent = '12';
    document.getElementById('credits-record-user').textContent = '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω';
    document.getElementById('deposits-record-value').textContent = '8';
    document.getElementById('deposits-record-user').textContent = '–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä';
    document.getElementById('krh-record-value').textContent = '24';
    document.getElementById('krh-record-user').textContent = '–°–∏–¥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–µ–π';
  } else {
    premiumLeaderboard.innerHTML = `
      <div class="leaderboard-item">
        <span class="rank">1</span>
        <span class="name">–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω</span>
        <span class="value">25,000 ‚ÇΩ</span>
      </div>
      <div class="leaderboard-item">
        <span class="rank">2</span>
        <span class="name">–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä</span>
        <span class="value">22,500 ‚ÇΩ</span>
      </div>
      <div class="leaderboard-item">
        <span class="rank">3</span>
        <span class="name">–°–∏–¥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–µ–π</span>
        <span class="value">20,000 ‚ÇΩ</span>
      </div>
    `;
    
    creditsLeaderboard.innerHTML = `
      <div class="leaderboard-item">
        <span class="rank">1</span>
        <span class="name">–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω</span>
        <span class="value">8 —à—Ç.</span>
      </div>
      <div class="leaderboard-item">
        <span class="rank">2</span>
        <span class="name">–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä</span>
        <span class="value">7 —à—Ç.</span>
      </div>
      <div class="leaderboard-item">
        <span class="rank">3</span>
        <span class="name">–°–∏–¥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–µ–π</span>
        <span class="value">6 —à—Ç.</span>
      </div>
    `;
    
    depositsLeaderboard.innerHTML = `
      <div class="leaderboard-item">
        <span class="rank">1</span>
        <span class="name">–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω</span>
        <span class="value">12 —à—Ç.</span>
      </div>
      <div class="leaderboard-item">
        <span class="rank">2</span>
        <span class="name">–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä</span>
        <span class="value">10 —à—Ç.</span>
      </div>
      <div class="leaderboard-item">
        <span class="rank">3</span>
        <span class="name">–°–∏–¥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–µ–π</span>
        <span class="value">9 —à—Ç.</span>
      </div>
    `;
    
    document.getElementById('current-period-leaderboard').style.display = 'block';
    document.getElementById('last-month-leaderboard').style.display = 'none';
    document.getElementById('records-leaderboard').style.display = 'none';
  }
}

// üîß –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–†–û–§–ò–õ–Ø

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
async function loadProfile() {
  await loadAchievements();
  await loadPremiumHistory();
  await loadProfileStats();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
async function loadAchievements() {
  const badgeGrid = document.getElementById('badge-grid');
  const achievements = [
    { id: 1, name: '–ü–µ—Ä–≤—ã–π –∫—Ä–µ–¥–∏—Ç', desc: '–û—Ñ–æ—Ä–º–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∫—Ä–µ–¥–∏—Ç', icon: 'fas fa-award', unlocked: true },
    { id: 2, name: '–ú–∞—Å—Ç–µ—Ä –ø—Ä–æ–¥–∞–∂', desc: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–ª–∞–Ω –Ω–∞ 100%', icon: 'fas fa-trophy', unlocked: false },
    { id: 3, name: '–≠–∫—Å–ø–µ—Ä—Ç –ø–æ –≤–∫–ª–∞–¥–∞–º', desc: '–û—Ñ–æ—Ä–º–∏—Ç–µ 10 –≤–∫–ª–∞–¥–æ–≤', icon: 'fas fa-coins', unlocked: false },
    { id: 4, name: '–ó–æ–ª–æ—Ç–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç', desc: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 50,000‚ÇΩ –ø—Ä–µ–º–∏–∏', icon: 'fas fa-medal', unlocked: false },
    { id: 5, name: '–ö–æ–º–∞–Ω–¥–Ω—ã–π –∏–≥—Ä–æ–∫', desc: '–†–∞–±–æ—Ç–∞–π—Ç–µ –≤ –∫–æ–º–∞–Ω–¥–µ –†–ì–ü–ü', icon: 'fas fa-users', unlocked: false },
    { id: 6, name: '–°—Ç—Ä–∞—Ç–µ–≥', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ —Å—Ç—Ä–∞—Ç—ã 1', icon: 'fas fa-chess-queen', unlocked: false }
  ];
  
  badgeGrid.innerHTML = achievements.map(achievement => `
    <div class="badge ${achievement.unlocked ? 'unlocked' : 'locked'}">
      <div class="badge-icon">
        <i class="${achievement.icon}"></i>
      </div>
      <div class="badge-name">${achievement.name}</div>
      <div class="badge-desc">${achievement.desc}</div>
    </div>
  `).join('');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–µ–º–∏–π - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
async function loadPremiumHistory() {
  if (!currentUser || currentUser.id === 'demo' || !firebaseInitialized) {
    showDemoPremiumHistory();
    return;
  }
  
  try {
    showLoader("–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–µ–º–∏–π...");
    
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1;
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –º–µ—Å—è—Ü–µ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (12 –º–µ—Å—è—Ü–µ–≤)
    const monthsToShow = [];
    for (let i = 0; i < 12; i++) {
      let year = currentYear;
      let month = currentMonth - i;
      
      if (month < 1) {
        month += 12;
        year -= 1;
      }
      
      monthsToShow.push({
        year: year,
        month: month,
        monthKey: `${year}-${month.toString().padStart(2, '0')}`,
        monthName: `${MONTHS_GENITIVE[month-1]} ${year}`
      });
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ—Ç—á–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤
    const monthlyReportsSnapshot = await db.collection('monthlyReports')
      .where('userId', '==', String(currentUser.id))
      .where('monthKey', 'in', monthsToShow.map(m => m.monthKey))
      .get();
    
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    const reportsMap = new Map();
    monthlyReportsSnapshot.forEach(doc => {
      const report = doc.data();
      reportsMap.set(report.monthKey, { ...report, id: doc.id });
    });
    
    // –°–æ–∑–¥–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–µ–º–∏–π –¥–ª—è –≤—Å–µ—Ö 12 –º–µ—Å—è—Ü–µ–≤
    const premiumHistoryList = document.getElementById('premium-history-list');
    
    if (monthsToShow.length === 0) {
      premiumHistoryList.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
      hideLoader();
      return;
    }
    
    premiumHistoryList.innerHTML = monthsToShow.map(monthInfo => {
      const reportData = reportsMap.get(monthInfo.monthKey);
      const premium = reportData ? (reportData.adjustedPremium || reportData.calculatedPremium || 0) : 0;
      const hasReport = !!reportData;
      
      return `
        <div class="history-item">
          <span class="history-month">${monthInfo.monthName} ${!hasReport ? '<span class="no-report">(–Ω–µ—Ç –æ—Ç—á–µ—Ç–∞)</span>' : ''}</span>
          <span class="history-premium">${Math.round(premium).toLocaleString()} ‚ÇΩ</span>
          ${hasReport ? `
            <button class="edit-premium-btn" data-report-id="${reportData.id}" data-month="${monthInfo.monthName}">
              <i class="fas fa-edit"></i>
            </button>
          ` : ''}
        </div>
      `;
    }).join('');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.querySelectorAll('.edit-premium-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const reportId = this.getAttribute('data-report-id');
        const monthName = this.getAttribute('data-month');
        if (reportId) {
          editMonthlyPremium(reportId, monthName);
        }
      });
    });
    
    hideLoader();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–µ–º–∏–π:', error);
    hideLoader();
    showDemoPremiumHistory();
  }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–º–∏–∏ –∑–∞ –º–µ—Å—è—Ü
async function editMonthlyPremium(reportId, monthName) {
  if (!reportId || !firebaseInitialized) {
    showError('–í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ');
    return;
  }
  
  try {
    const reportDoc = await db.collection('monthlyReports').doc(reportId).get();
    if (!reportDoc.exists) {
      showError('–û—Ç—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }
    
    const report = reportDoc.data();
    const currentPremium = report.adjustedPremium || report.calculatedPremium || 0;
    
    const newPremium = prompt(`–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–µ–º–∏—é –∑–∞ ${monthName}:`, currentPremium);
    
    if (newPremium === null) return;
    
    const premiumValue = validateInput(newPremium, 0, 1000000);
    
    await db.collection('monthlyReports').doc(reportId).update({
      adjustedPremium: premiumValue
    });
    
    showSuccess('–ü—Ä–µ–º–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
    await loadProfile();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–º–∏–∏:', error);
    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–µ–º–∏–∏');
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
async function loadProfileStats() {
  if (!currentUser || currentUser.id === 'demo' || !firebaseInitialized) {
    showDemoProfileStats();
    return;
  }
  
  try {
    showLoader("–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...");
    
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1;
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –º–µ—Å—è—Ü–µ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (12 –º–µ—Å—è—Ü–µ–≤)
    const monthsToAnalyze = [];
    for (let i = 0; i < 12; i++) {
      let year = currentYear;
      let month = currentMonth - i;
      
      if (month < 1) {
        month += 12;
        year -= 1;
      }
      
      monthsToAnalyze.push(`${year}-${month.toString().padStart(2, '0')}`);
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ—Ç—á–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤
    const monthlyReportsSnapshot = await db.collection('monthlyReports')
      .where('userId', '==', String(currentUser.id))
      .where('monthKey', 'in', monthsToAnalyze)
      .get();
    
    let totalPremium = 0;
    let totalCredits = 0;
    let totalDeposits = 0;
    let reportCount = 0;
    
    monthlyReportsSnapshot.forEach(doc => {
      const report = doc.data();
      const premium = report.adjustedPremium || report.calculatedPremium || 0;
      
      totalPremium += premium;
      totalCredits += report.dkCount || 0;
      totalDeposits += report.vkladCount || 0;
      reportCount++;
    });
    
    const averagePremium = reportCount > 0 ? Math.round(totalPremium / reportCount) : 0;
    
    document.getElementById('total-premium').textContent = Math.round(totalPremium).toLocaleString() + ' ‚ÇΩ';
    document.getElementById('average-premium').textContent = averagePremium.toLocaleString() + ' ‚ÇΩ';
    document.getElementById('total-credits').textContent = totalCredits;
    document.getElementById('total-deposits').textContent = totalDeposits;
    
    hideLoader();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
    hideLoader();
    showDemoProfileStats();
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–µ–º–∏–π
function showDemoPremiumHistory() {
  const premiumHistoryList = document.getElementById('premium-history-list');
  
  const today = new Date();
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth();
  
  let demoHTML = '';
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 12 –º–µ—Å—è—Ü–µ–≤ (–≤–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π)
  for (let i = 0; i < 12; i++) {
    const monthDate = new Date(currentYear, currentMonth - i, 1);
    const monthName = `${MONTHS_GENITIVE[monthDate.getMonth()]} ${monthDate.getFullYear()}`;
    const hasReport = i < 8; // –î–µ–º–æ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—á–µ—Ç—ã –∑–∞ 8 –º–µ—Å—è—Ü–µ–≤
    const premium = hasReport ? Math.floor(Math.random() * 40000) + 10000 : 0;
    
    demoHTML += `
      <div class="history-item">
        <span class="history-month">${monthName} ${!hasReport ? '<span class="no-report">(–Ω–µ—Ç –æ—Ç—á–µ—Ç–∞)</span>' : ''}</span>
        <span class="history-premium">${premium.toLocaleString()} ‚ÇΩ</span>
        ${hasReport ? `
          <button class="edit-premium-btn" data-report-id="demo-${i}" data-month="${monthName}">
            <i class="fas fa-edit"></i>
          </button>
        ` : ''}
      </div>
    `;
  }
  
  premiumHistoryList.innerHTML = demoHTML;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–µ–º–æ-–∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  document.querySelectorAll('.edit-premium-btn[data-report-id^="demo-"]').forEach(btn => {
    btn.addEventListener('click', function() {
      showError('–í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ');
    });
  });
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
function showDemoProfileStats() {
  const totalPremium = 350000;
  const averagePremium = 29167;
  const totalCredits = 45;
  const totalDeposits = 60;
  
  document.getElementById('total-premium').textContent = totalPremium.toLocaleString() + ' ‚ÇΩ';
  document.getElementById('average-premium').textContent = averagePremium.toLocaleString() + ' ‚ÇΩ';
  document.getElementById('total-credits').textContent = totalCredits;
  document.getElementById('total-deposits').textContent = totalDeposits;
}

// üîß –ù–û–í–ê–Ø –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
async function initializeAdminPanel() {
  if (!checkAdminRights()) return;
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
  await loadAdminPlans();
  await loadAdminMotivationChanges();
  await loadAdminRecords();
  
  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω-–≤–∫–ª–∞–¥–æ–∫
  document.querySelectorAll('.admin-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
      
      this.classList.add('active');
      const tabId = this.getAttribute('data-tab');
      document.getElementById(tabId).classList.add('active');
      
      if (tabId === 'admin-plans') {
        loadAdminPlans();
      } else if (tabId === 'admin-changes') {
        loadAdminMotivationChanges();
      } else if (tabId === 'admin-records') {
        loadAdminRecords();
      }
    });
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤
  document.getElementById('save-plans-btn').addEventListener('click', saveAdminPlans);
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
  document.getElementById('save-changes-btn').addEventListener('click', saveMotivationChanges);
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–æ–≤ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
  document.getElementById('admin-save-record-btn').addEventListener('click', saveAdminRecord);
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
  initializeUserSearch('admin-user-search', 'admin-user-search-results', 'admin-selected-user', 'admin-selected-user-name', 'admin-selected-user-id');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
async function loadAdminPlans() {
  if (!firebaseInitialized) return;
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—Ü–∏–∏ –º–µ—Å—è—Ü–µ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞
    const planMonthSelect = document.getElementById('admin-plan-month');
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1;
    
    planMonthSelect.innerHTML = '';
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 12 –º–µ—Å—è—Ü–µ–≤ (—Ç–µ–∫—É—â–∏–π –∏ —Å–ª–µ–¥—É—é—â–∏–µ 11)
    for (let i = 0; i < 12; i++) {
      let year = currentYear;
      let month = currentMonth + i;
      
      // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≥–æ–¥ –∏ –º–µ—Å—è—Ü –µ—Å–ª–∏ –º–µ—Å—è—Ü –±–æ–ª—å—à–µ 12
      if (month > 12) {
        month -= 12;
        year += 1;
      }
      
      const monthDate = new Date(year, month - 1, 1);
      const option = document.createElement('option');
      option.value = `${year}-${month.toString().padStart(2, '0')}`;
      option.textContent = `${MONTHS_GENITIVE[month - 1]} ${year}`;
      
      // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü, –ø–æ–º–µ—á–∞–µ–º –µ–≥–æ –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–π
      if (i === 0) {
        option.selected = true;
      }
      
      planMonthSelect.appendChild(option);
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–ª–∞–Ω—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
    await loadCurrentPlans();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–Ω–æ–≤:', error);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ø–ª–∞–Ω–æ–≤
async function loadCurrentPlans() {
  if (!firebaseInitialized) return;
  
  try {
    const planMonthSelect = document.getElementById('admin-plan-month');
    const selectedMonth = planMonthSelect.value;
    
    const plansDoc = await db.collection('plans').doc(selectedMonth).get();
    
    if (plansDoc.exists) {
      const plans = plansDoc.data();
      document.getElementById('admin-krh-plan').value = plans.krh_plan || 14;
      document.getElementById('admin-vklad-volume-plan').value = plans.vklad_volume_plan || 1920000;
      document.getElementById('admin-vklad-count-plan').value = plans.vklad_count_plan || 4;
      document.getElementById('admin-dk-count-plan').value = plans.dk_count_plan || 2;
      document.getElementById('admin-dk-volume-plan').value = plans.dk_volume_plan || 960000;
      document.getElementById('admin-kvc-plan').value = plans.kvc_plan || 30;
    } else {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      document.getElementById('admin-krh-plan').value = 14;
      document.getElementById('admin-vklad-volume-plan').value = 1920000;
      document.getElementById('admin-vklad-count-plan').value = 4;
      document.getElementById('admin-dk-count-plan').value = 2;
      document.getElementById('admin-dk-volume-plan').value = 960000;
      document.getElementById('admin-kvc-plan').value = 30;
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—É—â–∏—Ö –ø–ª–∞–Ω–æ–≤:', error);
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ –∞–¥–º–∏–Ω–æ–º
async function saveAdminPlans() {
  if (!checkAdminRights()) {
    showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
    return;
  }
  
  if (!firebaseInitialized) return;
  
  try {
    showLoader("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤...");
    
    const planMonthSelect = document.getElementById('admin-plan-month');
    const selectedMonth = planMonthSelect.value;
    
    const krhPlan = validateInput(document.getElementById('admin-krh-plan').value, 0, 1000);
    const vkladVolumePlan = validateInput(document.getElementById('admin-vklad-volume-plan').value, 0, 100000000);
    const vkladCountPlan = validateInput(document.getElementById('admin-vklad-count-plan').value, 0, 1000);
    const dkCountPlan = validateInput(document.getElementById('admin-dk-count-plan').value, 0, 1000);
    const dkVolumePlan = validateInput(document.getElementById('admin-dk-volume-plan').value, 0, 100000000);
    const kvcPlan = validateInput(document.getElementById('admin-kvc-plan').value, 0, 1000);
    
    await db.collection('plans').doc(selectedMonth).set({
      krh_plan: krhPlan,
      vklad_volume_plan: vkladVolumePlan,
      vklad_count_plan: vkladCountPlan,
      dk_count_plan: dkCountPlan,
      dk_volume_plan: dkVolumePlan,
      kvc_plan: kvcPlan,
      updatedBy: currentUser.id,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    hideLoader();
    showSuccess('–ü–ª–∞–Ω–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–∞–Ω—ã –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ, –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ø–ª–∞–Ω –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
    const now = new Date();
    const currentMonthKey = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
    if (selectedMonth === currentMonthKey) {
      await loadPlansIntoCalculator();
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤:', error);
    hideLoader();
    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–ª–∞–Ω–æ–≤');
  }
}

// üîß –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ï–ö–û–†–î–û–í –ü–†–û–î–ê–ñ

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function initializeUserSearch(searchInputId, resultsContainerId, selectedUserContainerId, selectedUserNameId, selectedUserIdId) {
  const searchInput = document.getElementById(searchInputId);
  const resultsContainer = document.getElementById(resultsContainerId);
  const selectedUserContainer = document.getElementById(selectedUserContainerId);
  const selectedUserName = document.getElementById(selectedUserNameId);
  const selectedUserId = document.getElementById(selectedUserIdId);
  
  if (!searchInput) return;
  
  let searchTimeout = null;
  
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const searchTerm = this.value.trim();
    
    if (searchTerm.length < 2) {
      resultsContainer.style.display = 'none';
      return;
    }
    
    searchTimeout = setTimeout(async () => {
      await searchUsers(searchTerm, resultsContainer, selectedUserContainer, selectedUserName, selectedUserId);
    }, 300);
  });
  
  // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.custom-select-wrapper')) {
      resultsContainer.style.display = 'none';
    }
  });
}

// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
async function searchUsers(searchTerm, resultsContainer, selectedUserContainer, selectedUserName, selectedUserId) {
  if (!firebaseInitialized) {
    showDemoSearchResults(searchTerm, resultsContainer, selectedUserContainer, selectedUserName, selectedUserId);
    return;
  }
  
  try {
    const usersSnapshot = await db.collection('users')
      .where('role', '==', 'mpp')
      .get();
    
    const results = [];
    
    usersSnapshot.forEach(doc => {
      const user = doc.data();
      const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
      const username = user.username || '';
      
      if (fullName.toLowerCase().includes(searchTerm.toLowerCase()) || 
          username.toLowerCase().includes(searchTerm.toLowerCase())) {
        results.push({
          id: doc.id,
          name: fullName || '–ê–Ω–æ–Ω–∏–º',
          username: username
        });
      }
    });
    
    displaySearchResults(results, resultsContainer, selectedUserContainer, selectedUserName, selectedUserId);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
    showDemoSearchResults(searchTerm, resultsContainer, selectedUserContainer, selectedUserName, selectedUserId);
  }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
function displaySearchResults(results, resultsContainer, selectedUserContainer, selectedUserName, selectedUserId) {
  resultsContainer.innerHTML = '';
  
  if (results.length === 0) {
    resultsContainer.innerHTML = '<div class="no-results">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
    resultsContainer.style.display = 'block';
    return;
  }
  
  results.slice(0, 10).forEach(user => {
    const resultItem = document.createElement('div');
    resultItem.className = 'search-result-item';
    resultItem.textContent = user.name + (user.username ? ` (@${user.username})` : '');
    
    resultItem.addEventListener('click', function() {
      selectedUserName.textContent = user.name;
      selectedUserId.value = user.id;
      selectedUserContainer.style.display = 'block';
      resultsContainer.style.display = 'none';
    });
    
    resultsContainer.appendChild(resultItem);
  });
  
  resultsContainer.style.display = 'block';
}

// –î–µ–º–æ-—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
function showDemoSearchResults(searchTerm, resultsContainer, selectedUserContainer, selectedUserName, selectedUserId) {
  const demoUsers = [
    { id: 'demo-1', name: '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω', username: 'ivanov' },
    { id: 'demo-2', name: '–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä', username: 'petrov' },
    { id: 'demo-3', name: '–°–∏–¥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–µ–π', username: 'sidorov' }
  ];
  
  const filteredUsers = demoUsers.filter(user => 
    user.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    user.username.toLowerCase().includes(searchTerm.toLowerCase())
  );
  
  displaySearchResults(filteredUsers, resultsContainer, selectedUserContainer, selectedUserName, selectedUserId);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ –ø—Ä–æ–¥–∞–∂
async function loadSalesRecords() {
  document.getElementById('current-period-leaderboard').style.display = 'none';
  document.getElementById('last-month-leaderboard').style.display = 'none';
  document.getElementById('records-leaderboard').style.display = 'block';
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –∞–¥–º–∏–Ω–∞
  const isAdmin = checkAdminRights();
  document.getElementById('record-form').style.display = isAdmin ? 'block' : 'none';
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
  if (isAdmin) {
    initializeUserSearch('user-search', 'user-search-results', 'selected-user', 'selected-user-name', 'selected-user-id');
  }
  
  if (!firebaseInitialized) {
    showDemoLeaderboard('records');
    return;
  }
  
  try {
    showLoader("–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤...");
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∫–æ—Ä–¥—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    const recordsSnapshot = await db.collection('salesRecords').get();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const records = {
      credits: { value: 0, userName: '–†–µ–∫–æ—Ä–¥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', userId: null },
      deposits: { value: 0, userName: '–†–µ–∫–æ—Ä–¥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', userId: null },
      krh: { value: 0, userName: '–†–µ–∫–æ—Ä–¥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', userId: null }
    };
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã
    recordsSnapshot.forEach(doc => {
      const record = doc.data();
      const recordType = record.type;
      
      if (records[recordType] && record.value > records[recordType].value) {
        records[recordType] = {
          value: record.value,
          userName: record.userName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫',
          userId: record.userId
        };
      }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    document.getElementById('credits-record-value').textContent = records.credits.value;
    document.getElementById('credits-record-user').textContent = records.credits.userName;
    
    document.getElementById('deposits-record-value').textContent = records.deposits.value;
    document.getElementById('deposits-record-user').textContent = records.deposits.userName;
    
    document.getElementById('krh-record-value').textContent = records.krh.value;
    document.getElementById('krh-record-user').textContent = records.krh.userName;
    
    hideLoader();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤:', error);
    hideLoader();
    showDemoLeaderboard('records');
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–∞ (–¥–ª—è –∞–¥–º–∏–Ω–∞)
async function saveRecord() {
  if (!checkAdminRights()) {
    showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
    return;
  }
  
  if (!firebaseInitialized) return;
  
  try {
    showLoader("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–∞...");
    
    const userId = document.getElementById('selected-user-id').value;
    const recordType = document.getElementById('record-type').value;
    const recordValue = validateInput(document.getElementById('record-value').value, 0, 1000);
    
    if (!userId) {
      hideLoader();
      showError('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
      return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    const userDoc = await db.collection('users').doc(userId).get();
    if (!userDoc.exists) {
      hideLoader();
      showError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }
    
    const user = userDoc.data();
    const userName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || '–ê–Ω–æ–Ω–∏–º';
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∫–æ—Ä–¥ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    await db.collection('salesRecords').add({
      userId: userId,
      userName: userName,
      type: recordType,
      value: recordValue,
      updatedBy: currentUser.id,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    hideLoader();
    showSuccess('–†–µ–∫–æ—Ä–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–æ–≤
    await loadSalesRecords();
    
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('record-value').value = '0';
    document.getElementById('selected-user').style.display = 'none';
    document.getElementById('user-search').value = '';
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–∞:', error);
    hideLoader();
    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∫–æ—Ä–¥–∞');
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
async function loadAdminRecords() {
  if (!firebaseInitialized) {
    showDemoAdminRecords();
    return;
  }
  
  try {
    showLoader("–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤...");
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∫–æ—Ä–¥—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    const recordsSnapshot = await db.collection('salesRecords').get();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const records = {
      credits: { value: 0, userName: '–†–µ–∫–æ—Ä–¥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', userId: null, id: null },
      deposits: { value: 0, userName: '–†–µ–∫–æ—Ä–¥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', userId: null, id: null },
      krh: { value: 0, userName: '–†–µ–∫–æ—Ä–¥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', userId: null, id: null }
    };
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã
    recordsSnapshot.forEach(doc => {
      const record = doc.data();
      const recordType = record.type;
      
      if (records[recordType] && record.value > records[recordType].value) {
        records[recordType] = {
          value: record.value,
          userName: record.userName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫',
          userId: record.userId,
          id: doc.id
        };
      }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    document.getElementById('admin-credits-record-value').textContent = records.credits.value;
    document.getElementById('admin-credits-record-user').textContent = records.credits.userName;
    
    document.getElementById('admin-deposits-record-value').textContent = records.deposits.value;
    document.getElementById('admin-deposits-record-user').textContent = records.deposits.userName;
    
    document.getElementById('admin-krh-record-value').textContent = records.krh.value;
    document.getElementById('admin-krh-record-user').textContent = records.krh.userName;
    
    hideLoader();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:', error);
    hideLoader();
    showDemoAdminRecords();
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–∞ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
async function saveAdminRecord() {
  if (!checkAdminRights()) {
    showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
    return;
  }
  
  if (!firebaseInitialized) return;
  
  try {
    showLoader("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–∞...");
    
    const userId = document.getElementById('admin-selected-user-id').value;
    const recordType = document.getElementById('admin-record-type').value;
    const recordValue = validateInput(document.getElementById('admin-record-value').value, 0, 1000);
    
    if (!userId) {
      hideLoader();
      showError('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
      return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    const userDoc = await db.collection('users').doc(userId).get();
    if (!userDoc.exists) {
      hideLoader();
      showError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }
    
    const user = userDoc.data();
    const userName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || '–ê–Ω–æ–Ω–∏–º';
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∫–æ—Ä–¥ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    await db.collection('salesRecords').add({
      userId: userId,
      userName: userName,
      type: recordType,
      value: recordValue,
      updatedBy: currentUser.id,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    hideLoader();
    showSuccess('–†–µ–∫–æ—Ä–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–æ–≤
    await loadAdminRecords();
    
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('admin-record-value').value = '0';
    document.getElementById('admin-selected-user').style.display = 'none';
    document.getElementById('admin-user-search').value = '';
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–∞:', error);
    hideLoader();
    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∫–æ—Ä–¥–∞');
  }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–∞
async function editRecord(recordType) {
  if (!checkAdminRights()) {
    showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
    return;
  }
  
  const newValue = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∫–æ—Ä–¥–∞ "${recordType}":`);
  if (newValue === null) return;
  
  const recordValue = validateInput(newValue, 0, 1000);
  
  try {
    showLoader("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–∞...");
    
    // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∫–æ—Ä–¥ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
    const recordsSnapshot = await db.collection('salesRecords')
      .where('type', '==', recordType)
      .orderBy('value', 'desc')
      .limit(1)
      .get();
    
    if (!recordsSnapshot.empty) {
      const recordDoc = recordsSnapshot.docs[0];
      await db.collection('salesRecords').doc(recordDoc.id).update({
        value: recordValue,
        updatedBy: currentUser.id,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    hideLoader();
    showSuccess('–†–µ–∫–æ—Ä–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
    await loadAdminRecords();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–∞:', error);
    hideLoader();
    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–µ–∫–æ—Ä–¥–∞');
  }
}

// –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–¥–º–∏–Ω-—Ä–µ–∫–æ—Ä–¥–æ–≤
function showDemoAdminRecords() {
  document.getElementById('admin-credits-record-value').textContent = '12';
  document.getElementById('admin-credits-record-user').textContent = '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω';
  
  document.getElementById('admin-deposits-record-value').textContent = '8';
  document.getElementById('admin-deposits-record-user').textContent = '–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä';
  
  document.getElementById('admin-krh-record-value').textContent = '24';
  document.getElementById('admin-krh-record-user').textContent = '–°–∏–¥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–µ–π';
}

// üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï

document.addEventListener('DOMContentLoaded', async function() {
  console.log("DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase –¥–æ –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ
  await initializeFirebase();
  
  initTelegram();
  initTheme();

  document.getElementById('themeToggle').addEventListener('click', toggleTheme);

  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      this.classList.add('active');
      const tabId = this.getAttribute('data-tab');
      document.getElementById(tabId).classList.add('active');
      
      if (tabId === 'leaderboard-tab') {
        loadLeaderboard('week');
      } else if (tabId === 'reports-tab') {
        loadWeekOptions();
        loadMonthOptions();
      } else if (tabId === 'profile-tab') {
        loadProfile();
      } else if (tabId === 'admin-tab') {
        // –î–ª—è –∞–¥–º–∏–Ω–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫—É –ø–ª–∞–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
        document.querySelector('.admin-tab[data-tab="admin-plans"]').classList.add('active');
        document.getElementById('admin-plans').classList.add('active');
        
        loadAdminPlans();
      }
    });
  });

  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      const period = this.getAttribute('data-period');
      loadLeaderboard(period);
    });
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–æ–≤
  document.getElementById('save-record-btn').addEventListener('click', saveRecord);

  console.log("–í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã");
});
</script>
</body>
</html>