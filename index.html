<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–µ–º–∏–∏ –ú–ü–ü</title>
<base href="/mpp-premium-calculator/">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
:root {
  --primary: #2c3e50;
  --secondary: #3498db;
  --accent: #e74c3c;
  --success: #27ae60;
  --warning: #f39c12;
  --light: #ecf0f1;
  --dark: #34495e;
  --bg-color: #ffffff;
  --text-color: #333333;
  --card-bg: #f8f9fa;
  --border-color: #ddd;
}

[data-theme="dark"] {
  --primary: #3498db;
  --secondary: #2980b9;
  --accent: #e74c3c;
  --success: #27ae60;
  --warning: #f39c12;
  --light: #2c3e50;
  --dark: #ecf0f1;
  --bg-color: #1a1a1a;
  --text-color: #ffffff;
  --card-bg: #2d2d2d;
  --border-color: #444;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
  background: var(--bg-color);
  min-height: 100vh;
  color: var(--text-color);
  font-size: 16px;
  transition: all 0.3s ease;
}

.container {
  display: none;
  max-width: 100%;
  margin: 0 auto;
  background: var(--bg-color);
  border-radius: 15px;
  overflow: hidden;
  position: relative;
  transition: all 0.3s ease;
  padding-bottom: 70px;
}

/* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */

</style>
</head>
<body>
<div class="container">
<!-- –í–µ—Å—å HTML –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
</div>

<script>
// üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyCdQ8_gViAkfeHvabiHI5n9C9EP7hQW_j4",
  authDomain: "mpp-premium-calculator.firebaseapp.com",
  projectId: "mpp-premium-calculator",
  storageBucket: "mpp-premium-calculator.firebasestorage.app",
  messagingSenderId: "310897873427",
  appId: "1:310897873427:web:f2b65971191ca4359aa5e6"
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
let db;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  console.log("Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ");
} catch (error) {
  console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
}

// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ —Ñ—É–Ω–∫—Ü–∏–∏ loadExportMonthOptions ...

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—Ü–∏–π –º–µ—Å—è—Ü–µ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
async function loadExportMonthOptions() {
  if (!currentUser || currentUser.id === 'demo' || !db) {
    const exportMonthSelect = document.getElementById('export-month-select');
    exportMonthSelect.innerHTML = '<option value="demo">–î–µ–º–æ –æ—Ç—á–µ—Ç (–û–∫—Ç—è–±—Ä—å 2023)</option>';
    return;
  }

  try {
    const monthlyReportsSnapshot = await db.collection('monthlyReports')
      .where('userId', '==', String(currentUser.id))
      .orderBy('createdAt', 'desc')
      .get();

    const exportMonthSelect = document.getElementById('export-month-select');
    exportMonthSelect.innerHTML = '';

    if (monthlyReportsSnapshot.empty) {
      exportMonthSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤</option>';
      return;
    }

    monthlyReportsSnapshot.forEach(doc => {
      const report = doc.data();
      const option = document.createElement('option');
      option.value = report.monthKey;
      option.textContent = report.monthName;
      exportMonthSelect.appendChild(option);
    });

    console.log("–ó–∞–≥—Ä—É–∂–µ–Ω—ã –º–µ—Å—è—Ü—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞:", monthlyReportsSnapshot.size, "–æ—Ç—á–µ—Ç–æ–≤");
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Å—è—Ü–µ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
    const exportMonthSelect = document.getElementById('export-month-select');
    exportMonthSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
  }
}

// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ —Ñ—É–Ω–∫—Ü–∏–∏ previewPDFReport ...

// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä PDF –æ—Ç—á–µ—Ç–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
async function previewPDFReport() {
  const exportMonthSelect = document.getElementById('export-month-select');
  const selectedMonthKey = exportMonthSelect.value;

  if (!selectedMonthKey) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
    return;
  }

  // –î–µ–º–æ-—Ä–µ–∂–∏–º
  if (selectedMonthKey === 'demo') {
    showDemoPDFPreview();
    return;
  }

  const monthlyReportData = await getMonthlyReport(selectedMonthKey);
  if (!monthlyReportData) {
    alert('–û—Ç—á–µ—Ç –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }

  fillPDFPreview(monthlyReportData);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
  document.getElementById('pdf-preview').style.display = 'block';
  document.getElementById('pdf-preview').scrollIntoView({ behavior: 'smooth' });
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ PDF –ø—Ä–µ–≤—å—é –¥–∞–Ω–Ω—ã–º–∏
function fillPDFPreview(monthlyReportData) {
  // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–µ–≤—å—é
  document.getElementById('pdf-period').textContent = `–ü–µ—Ä–∏–æ–¥: ${monthlyReportData.monthName}`;
  document.getElementById('pdf-employee-name').textContent = `${currentUser.firstName} ${currentUser.lastName || ''}`;
  document.getElementById('pdf-generation-date').textContent = new Date().toLocaleDateString('ru-RU');
  
  // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
  const mainIndicators = document.getElementById('pdf-main-indicators');
  const kvcPercent = Math.round(((monthlyReportData.kvc || 0) / 30) * 100) || 0;
  const krhPercent = Math.round(((monthlyReportData.krh || 0) / 15) * 100) || 0;
  const dkPercent = Math.round(((monthlyReportData.dkVolume || 0) / 960000) * 100) || 0;
  const vkladPercent = Math.round(((monthlyReportData.vkladVolume || 0) / 1920000) * 100) || 0;
  
  mainIndicators.innerHTML = `
    <tr>
      <td>–ö–í–¶ –∫–ª–∏–µ–Ω—Ç—ã</td>
      <td>30</td>
      <td>${monthlyReportData.kvc || 0}</td>
      <td>${kvcPercent}%</td>
    </tr>
    <tr>
      <td>–ö–†–• —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–æ</td>
      <td>15</td>
      <td>${monthlyReportData.krh || 0}</td>
      <td>${krhPercent}%</td>
    </tr>
    <tr>
      <td>–î–ö –æ–±—ä–µ–º</td>
      <td>960,000 ‚ÇΩ</td>
      <td>${(monthlyReportData.dkVolume || 0).toLocaleString()} ‚ÇΩ</td>
      <td>${dkPercent}%</td>
    </tr>
    <tr>
      <td>–í–∫–ª–∞–¥ –æ–±—ä–µ–º</td>
      <td>1,920,000 ‚ÇΩ</td>
      <td>${(monthlyReportData.vkladVolume || 0).toLocaleString()} ‚ÇΩ</td>
      <td>${vkladPercent}%</td>
    </tr>
  `;
  
  // –ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
  const creditsTable = document.getElementById('pdf-credits-table');
  let creditsHTML = '';
  let totalCreditsPremium = 0;
  
  if (monthlyReportData.credits && monthlyReportData.credits.length > 0) {
    monthlyReportData.credits.forEach(credit => {
      const creditTypeName = CREDIT_TYPES[credit.type]?.name || credit.type;
      const packageName = PACKAGES.find(p => p.value == credit.package)?.name || credit.package;
      totalCreditsPremium += credit.premium || 0;
      
      creditsHTML += `
        <tr>
          <td>${creditTypeName}</td>
          <td>${(credit.amount || 0).toLocaleString()} ‚ÇΩ</td>
          <td>${packageName}</td>
          <td>${credit.fz ? '–î–∞' : '–ù–µ—Ç'}</td>
          <td>${(credit.premium || 0).toLocaleString()} ‚ÇΩ</td>
        </tr>
      `;
    });
  } else {
    creditsHTML = '<tr><td colspan="5" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
  }
  
  creditsTable.innerHTML = creditsHTML;
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
  const additionalProducts = document.getElementById('pdf-additional-products');
  const additionalPremium = 
    (monthlyReportData.stickerCount * 50) +
    (monthlyReportData.yearSubCount * 500) +
    (monthlyReportData.monthSubCount * 200) +
    (monthlyReportData.krhLimitCount * 100) +
    (monthlyReportData.zpCardCount * 100) +
    (monthlyReportData.ompCount * 50) +
    (monthlyReportData.zpNerezCount * 300) +
    Math.min((monthlyReportData.cardTurnover || 0) * 0.03, 100000);
  
  additionalProducts.innerHTML = `
    <tr>
      <td>–°—Ç–∏–∫–µ—Ä—ã</td>
      <td>${monthlyReportData.stickerCount || 0}</td>
      <td>${((monthlyReportData.stickerCount || 0) * 50).toLocaleString()} ‚ÇΩ</td>
    </tr>
    <tr>
      <td>–ü–æ–¥–ø–∏—Å–∫–∏ –≥–æ–¥–æ–≤—ã–µ</td>
      <td>${monthlyReportData.yearSubCount || 0}</td>
      <td>${((monthlyReportData.yearSubCount || 0) * 500).toLocaleString()} ‚ÇΩ</td>
    </tr>
    <tr>
      <td>–ü–æ–¥–ø–∏—Å–∫–∏ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ</td>
      <td>${monthlyReportData.monthSubCount || 0}</td>
      <td>${((monthlyReportData.monthSubCount || 0) * 200).toLocaleString()} ‚ÇΩ</td>
    </tr>
    <tr>
      <td>–ö–†–• –õ–∏–º–∏—Ç</td>
      <td>${monthlyReportData.krhLimitCount || 0}</td>
      <td>${((monthlyReportData.krhLimitCount || 0) * 100).toLocaleString()} ‚ÇΩ</td>
    </tr>
    <tr>
      <td>–ó–ü –∫–∞—Ä—Ç—ã</td>
      <td>${monthlyReportData.zpCardCount || 0}</td>
      <td>${((monthlyReportData.zpCardCount || 0) * 100).toLocaleString()} ‚ÇΩ</td>
    </tr>
    <tr>
      <td>–û–ú–ü</td>
      <td>${monthlyReportData.ompCount || 0}</td>
      <td>${((monthlyReportData.ompCount || 0) * 50).toLocaleString()} ‚ÇΩ</td>
    </tr>
    <tr>
      <td>–ó–ü –Ω–µ—Ä–µ–∑</td>
      <td>${monthlyReportData.zpNerezCount || 0}</td>
      <td>${((monthlyReportData.zpNerezCount || 0) * 300).toLocaleString()} ‚ÇΩ</td>
    </tr>
    <tr>
      <td>–û–±–æ—Ä–æ—Ç –ø–æ –∫–∞—Ä—Ç–∞–º</td>
      <td>${(monthlyReportData.cardTurnover || 0).toLocaleString()} ‚ÇΩ</td>
      <td>${Math.min((monthlyReportData.cardTurnover || 0) * 0.03, 100000).toLocaleString()} ‚ÇΩ</td>
    </tr>
  `;
  
  // –ß–µ–º–ø–∏–æ–Ω–∞—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤
  const championship = document.getElementById('pdf-championship');
  let skbPoints = (monthlyReportData.skbCount || 0) < 3 ? 1 : -1;
  let crmPoints = 0;
  
  if ((monthlyReportData.crmCalls || 0) <= 50) {
    crmPoints = 2;
  } else if ((monthlyReportData.crmCalls || 0) > 50 && (monthlyReportData.crmCalls || 0) < 60) {
    crmPoints = 0;
  } else {
    crmPoints = -2;
  }
  
  championship.innerHTML = `
    <tr>
      <td>–°–ö–ë (–¥–µ–±–µ—Ç–æ–≤—ã–µ —Å 2%)</td>
      <td>${monthlyReportData.skbCount || 0}</td>
      <td>${skbPoints}</td>
    </tr>
    <tr>
      <td>–î–æ–∑–≤–æ–Ω—ã CRM</td>
      <td>${monthlyReportData.crmCalls || 0}</td>
      <td>${crmPoints}</td>
    </tr>
  `;
  
  // –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–µ–º–∏—è
  const totalPremium = calculateTotalPremium(monthlyReportData);
  document.getElementById('pdf-total-premium').textContent = `–ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–µ–º–∏—è: ${Math.round(totalPremium).toLocaleString()} ‚ÇΩ`;
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–º–æ-–ø—Ä–µ–≤—å—é PDF
function showDemoPDFPreview() {
  const demoReport = {
    monthName: "–û–∫—Ç—è–±—Ä—å 2023",
    kvc: 25,
    krh: 12,
    dkVolume: 850000,
    vkladVolume: 1750000,
    credits: [
      { type: "zp", amount: 500000, package: "500", fz: true, premium: 1000 },
      { type: "prime", amount: 300000, package: "1400", fz: true, premium: 2900 },
      { type: "autocredit", amount: 1200000, package: "2000", fz: true, premium: 3250 }
    ],
    stickerCount: 5,
    yearSubCount: 2,
    monthSubCount: 8,
    krhLimitCount: 3,
    zpCardCount: 4,
    ompCount: 6,
    zpNerezCount: 2,
    cardTurnover: 150000,
    skbCount: 4,
    crmCalls: 45
  };
  
  fillPDFPreview(demoReport);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
  document.getElementById('pdf-preview').style.display = 'block';
  document.getElementById('pdf-preview').scrollIntoView({ behavior: 'smooth' });
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –æ—Ç—á–µ—Ç–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
async function generatePDFReport() {
  const exportMonthSelect = document.getElementById('export-month-select');
  const selectedMonthKey = exportMonthSelect.value;

  if (!selectedMonthKey) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
    return;
  }

  // –î–µ–º–æ-—Ä–µ–∂–∏–º
  if (selectedMonthKey === 'demo') {
    generateDemoPDF();
    return;
  }

  const monthlyReportData = await getMonthlyReport(selectedMonthKey);
  if (!monthlyReportData) {
    alert('–û—Ç—á–µ—Ç –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }

  generatePDFFromData(monthlyReportData);
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –∏–∑ –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞
function generatePDFFromData(monthlyReportData) {
  // –°–æ–∑–¥–∞–µ–º PDF –¥–æ–∫—É–º–µ–Ω—Ç
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à—Ä–∏—Ñ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –∫–∏—Ä–∏–ª–ª–∏—Ü—É
  doc.setFont('helvetica');
  
  // –ó–∞–≥–æ–ª–æ–≤–æ–∫
  doc.setFontSize(20);
  doc.setTextColor(44, 62, 80);
  doc.text('–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç –ú–ü–ü', 105, 20, { align: 'center' });
  
  doc.setFontSize(12);
  doc.setTextColor(127, 140, 141);
  doc.text(`–ü–µ—Ä–∏–æ–¥: ${monthlyReportData.monthName}`, 105, 30, { align: 'center' });
  
  // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ –∏ –¥–∞—Ç–µ
  doc.setFontSize(10);
  doc.setTextColor(0, 0, 0);
  doc.text(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${currentUser.firstName} ${currentUser.lastName || ''}`, 20, 45);
  doc.text(`–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')}`, 20, 52);
  
  let yPosition = 70;
  
  // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
  doc.setFontSize(14);
  doc.setTextColor(44, 62, 80);
  doc.text('–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏', 20, yPosition);
  yPosition += 10;
  
  doc.setFontSize(10);
  doc.setTextColor(0, 0, 0);
  
  // –¢–∞–±–ª–∏—Ü–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
  const kvcPercent = Math.round(((monthlyReportData.kvc || 0) / 30) * 100) || 0;
  const krhPercent = Math.round(((monthlyReportData.krh || 0) / 15) * 100) || 0;
  const dkPercent = Math.round(((monthlyReportData.dkVolume || 0) / 960000) * 100) || 0;
  const vkladPercent = Math.round(((monthlyReportData.vkladVolume || 0) / 1920000) * 100) || 0;
  
  const mainIndicators = [
    ['–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å', '–ü–ª–∞–Ω', '–§–∞–∫—Ç', '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ'],
    ['–ö–í–¶ –∫–ª–∏–µ–Ω—Ç—ã', '30', `${monthlyReportData.kvc || 0}`, `${kvcPercent}%`],
    ['–ö–†–• —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–æ', '15', `${monthlyReportData.krh || 0}`, `${krhPercent}%`],
    ['–î–ö –æ–±—ä–µ–º', '960,000 ‚ÇΩ', `${(monthlyReportData.dkVolume || 0).toLocaleString()} ‚ÇΩ`, `${dkPercent}%`],
    ['–í–∫–ª–∞–¥ –æ–±—ä–µ–º', '1,920,000 ‚ÇΩ', `${(monthlyReportData.vkladVolume || 0).toLocaleString()} ‚ÇΩ`, `${vkladPercent}%`]
  ];
  
  doc.autoTable({
    startY: yPosition,
    head: [mainIndicators[0]],
    body: mainIndicators.slice(1),
    theme: 'grid',
    headStyles: { fillColor: [52, 152, 219] },
    styles: { fontSize: 9 },
    margin: { left: 20, right: 20 }
  });
  
  yPosition = doc.lastAutoTable.finalY + 15;
  
  // –ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
  if (monthlyReportData.credits && monthlyReportData.credits.length > 0) {
    doc.setFontSize(14);
    doc.setTextColor(44, 62, 80);
    doc.text('–ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã', 20, yPosition);
    yPosition += 10;
    
    const creditsData = [['–¢–∏–ø –∫—Ä–µ–¥–∏—Ç–∞', '–°—É–º–º–∞', '–ü–∞–∫–µ—Ç –∑–∞—â–∏—Ç—ã', '–§–ó', '–ü—Ä–µ–º–∏—è']];
    
    monthlyReportData.credits.forEach(credit => {
      const creditTypeName = CREDIT_TYPES[credit.type]?.name || credit.type;
      const packageName = PACKAGES.find(p => p.value == credit.package)?.name || credit.package;
      
      creditsData.push([
        creditTypeName,
        `${(credit.amount || 0).toLocaleString()} ‚ÇΩ`,
        packageName,
        credit.fz ? '–î–∞' : '–ù–µ—Ç',
        `${(credit.premium || 0).toLocaleString()} ‚ÇΩ`
      ]);
    });
    
    doc.autoTable({
      startY: yPosition,
      head: [creditsData[0]],
      body: creditsData.slice(1),
      theme: 'grid',
      headStyles: { fillColor: [52, 152, 219] },
      styles: { fontSize: 8 },
      margin: { left: 20, right: 20 }
    });
    
    yPosition = doc.lastAutoTable.finalY + 15;
  }
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
  doc.setFontSize(14);
  doc.setTextColor(44, 62, 80);
  doc.text('–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã', 20, yPosition);
  yPosition += 10;
  
  const additionalData = [['–ü—Ä–æ–¥—É–∫—Ç', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', '–ü—Ä–µ–º–∏—è']];
  
  const additionalProducts = [
    ['–°—Ç–∏–∫–µ—Ä—ã', monthlyReportData.stickerCount || 0, (monthlyReportData.stickerCount || 0) * 50],
    ['–ü–æ–¥–ø–∏—Å–∫–∏ –≥–æ–¥–æ–≤—ã–µ', monthlyReportData.yearSubCount || 0, (monthlyReportData.yearSubCount || 0) * 500],
    ['–ü–æ–¥–ø–∏—Å–∫–∏ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ', monthlyReportData.monthSubCount || 0, (monthlyReportData.monthSubCount || 0) * 200],
    ['–ö–†–• –õ–∏–º–∏—Ç', monthlyReportData.krhLimitCount || 0, (monthlyReportData.krhLimitCount || 0) * 100],
    ['–ó–ü –∫–∞—Ä—Ç—ã', monthlyReportData.zpCardCount || 0, (monthlyReportData.zpCardCount || 0) * 100],
    ['–û–ú–ü', monthlyReportData.ompCount || 0, (monthlyReportData.ompCount || 0) * 50],
    ['–ó–ü –Ω–µ—Ä–µ–∑', monthlyReportData.zpNerezCount || 0, (monthlyReportData.zpNerezCount || 0) * 300],
    ['–û–±–æ—Ä–æ—Ç –ø–æ –∫–∞—Ä—Ç–∞–º', (monthlyReportData.cardTurnover || 0).toLocaleString() + ' ‚ÇΩ', Math.min((monthlyReportData.cardTurnover || 0) * 0.03, 100000)]
  ];
  
  additionalProducts.forEach(product => {
    additionalData.push([product[0], product[1], `${product[2].toLocaleString()} ‚ÇΩ`]);
  });
  
  doc.autoTable({
    startY: yPosition,
    head: [additionalData[0]],
    body: additionalData.slice(1),
    theme: 'grid',
    headStyles: { fillColor: [52, 152, 219] },
    styles: { fontSize: 9 },
    margin: { left: 20, right: 20 }
  });
  
  yPosition = doc.lastAutoTable.finalY + 15;
  
  // –ß–µ–º–ø–∏–æ–Ω–∞—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤
  doc.setFontSize(14);
  doc.setTextColor(44, 62, 80);
  doc.text('–ß–µ–º–ø–∏–æ–Ω–∞—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤', 20, yPosition);
  yPosition += 10;
  
  let skbPoints = (monthlyReportData.skbCount || 0) < 3 ? 1 : -1;
  let crmPoints = 0;
  
  if ((monthlyReportData.crmCalls || 0) <= 50) {
    crmPoints = 2;
  } else if ((monthlyReportData.crmCalls || 0) > 50 && (monthlyReportData.crmCalls || 0) < 60) {
    crmPoints = 0;
  } else {
    crmPoints = -2;
  }
  
  const championshipData = [
    ['–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å', '–ó–Ω–∞—á–µ–Ω–∏–µ', '–ë–∞–ª–ª—ã'],
    ['–°–ö–ë (–¥–µ–±–µ—Ç–æ–≤—ã–µ —Å 2%)', monthlyReportData.skbCount || 0, skbPoints],
    ['–î–æ–∑–≤–æ–Ω—ã CRM', monthlyReportData.crmCalls || 0, crmPoints]
  ];
  
  doc.autoTable({
    startY: yPosition,
    head: [championshipData[0]],
    body: championshipData.slice(1),
    theme: 'grid',
    headStyles: { fillColor: [52, 152, 219] },
    styles: { fontSize: 9 },
    margin: { left: 20, right: 20 }
  });
  
  yPosition = doc.lastAutoTable.finalY + 20;
  
  // –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–µ–º–∏—è
  const totalPremium = calculateTotalPremium(monthlyReportData);
  
  doc.setFontSize(16);
  doc.setTextColor(39, 174, 96);
  doc.text(`–ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–µ–º–∏—è: ${Math.round(totalPremium).toLocaleString()} ‚ÇΩ`, 105, yPosition, { align: 'center' });
  
  yPosition += 10;
  
  // –§—É—Ç–µ—Ä
  doc.setFontSize(10);
  doc.setTextColor(127, 140, 141);
  doc.text('–û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–µ–º–∏–∏ –ú–ü–ü', 105, yPosition, { align: 'center' });
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º PDF
  doc.save(`–û—Ç—á–µ—Ç_–ú–ü–ü_${monthlyReportData.monthName.replace(' ', '_')}.pdf`);
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ–º–æ-PDF
function generateDemoPDF() {
  const demoReport = {
    monthName: "–û–∫—Ç—è–±—Ä—å 2023",
    kvc: 25,
    krh: 12,
    dkVolume: 850000,
    vkladVolume: 1750000,
    credits: [
      { type: "zp", amount: 500000, package: "500", fz: true, premium: 1000 },
      { type: "prime", amount: 300000, package: "1400", fz: true, premium: 2900 },
      { type: "autocredit", amount: 1200000, package: "2000", fz: true, premium: 3250 }
    ],
    stickerCount: 5,
    yearSubCount: 2,
    monthSubCount: 8,
    krhLimitCount: 3,
    zpCardCount: 4,
    ompCount: 6,
    zpNerezCount: 2,
    cardTurnover: 150000,
    skbCount: 4,
    crmCalls: 45
  };
  
  generatePDFFromData(demoReport);
}

// üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï

document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");
  initTelegram();
  initTheme();

  document.getElementById('themeToggle').addEventListener('click', toggleTheme);

  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      this.classList.add('active');
      const tabId = this.getAttribute('data-tab');
      document.getElementById(tabId).classList.add('active');
      
      if (tabId === 'leaderboard-tab') {
        loadLeaderboard('week');
      } else if (tabId === 'reports-tab') {
        loadWeekOptions();
      } else if (tabId === 'profile-tab') {
        loadProfile();
      } else if (tabId === 'admin-tab') {
        loadAdminData();
      }
    });
  });

  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      const period = this.getAttribute('data-period');
      loadLeaderboard(period);
    });
  });

  console.log("–í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã");
});
</script>
</body>
</html>